---
title: "EEID 1A Antibody Analysis"
author: "Jesse Garrett-Larsen"
date: "2024-01-26"
fig_width: 10 
fig_height: 6
output: 
  html_document: 
---

Load packages
```{r Load Packages}
rm(list=ls())
library(tidyverse)
library(dplyr)
library(gtsummary)
#install.packages("glmmTMB")
library(glmmTMB)
library(effects)
library(AICcmodavg)
#install.packages("emmeans")
library(emmeans)
library(MASS)
library(DHARMa)
library(lme4)
```

```{r Source Data}
source("dataCleaning_EEID1A.R")
```

Format Graphs
```{r Set Colors}
#set color scheme primary treatment
#pri_colors <- c("#619CFF", "#00BA38", "#F8766D")
pri_colors <- c("#D95F02", "#7570B3", "#1B9E77")
#set color scheme secondary treatment
sec_colors <- c("#8C754B", "#77AB59", "#59A5D8", "#9F77D9", "#FA8072")



```

```{r Sample Size Summary}
m.ab %>%
  dplyr::select(dpi, primary_treatment, secondary_dose)%>%
  tbl_summary(
    by=dpi
  )
```

Generate Threshold Cutoffs for Pathogen Load and Antibody Levels
```{r Thresholds}
m.ab$threshold_cutoff = 50
m.ab$seropos_cutoff = 0.061
m.ab$pathology_cutoff = 0
```
Generate new infected and seroconversion columns based off of cutoffs
```{r Infection + Seroconversion + Eye Score}
#generate infected column - if copy number > 50, infected.
#for each timepoint only - can become infected or uninfected at next timepoint
m.ab <- m.ab %>%
  mutate(infected = ifelse(quantity>threshold_cutoff, 1, 0))

#generate infection data; if path load > 50 copies = infected
#1 = bird was successfully infected at any point during the priming phase of the experiment
#coalesce function replaces any NA with 0 here. 
#To be conservative, I am always assuming there is no path load unless it's measured with qPCR
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(infected_prim = ifelse(dpi < 42 & any(coalesce(infected, 0) == 1), 1, 0)) %>%
  ungroup()

#generate infection data; if path load > 50 copies any time after secondary infection -> 1
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate (infected_sec = ifelse(dpi > 42 & any(coalesce(infected, 0) == 1), 1, 0)) %>%
  ungroup()

#generate seropositivity data; if elisa OD > 0.061 = seropositive
#can become seropos or not at any point
m.ab <- m.ab %>%
  mutate(seropos = ifelse(elisa_od>seropos_cutoff, 1, 0))

#Seropos at any time during the priming phase
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(seropos_prim = ifelse(dpi < 42 & any(coalesce(seropos, 0) == 1), 1, 0)) %>%
  ungroup()

#Seropos at any time during the secondary phase
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(seropos_sec = ifelse(dpi > 42 & any(coalesce(seropos, 0) == 1), 1, 0)) %>%
  ungroup()

#generate eye score data; if eye score > 0 = diseased
#1 = bird had an eye score at that time point
m.ab <- m.ab %>%
  mutate(diseased = ifelse(tes>pathology_cutoff, 1, 0))

#ever diseased during primary infection
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(diseased_prim = ifelse(dpi < 42 & any(coalesce(diseased, 0) == 1), 1, 0)) %>%
  ungroup()

#ever diseased during secondary infection
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(diseased_sec = ifelse(dpi > 42 & any(coalesce(diseased, 0) == 1), 1, 0)) %>%
  ungroup()

#Rules for infection: We defined a bird as infected if it had eye score > 0, pathogen load > 50 copies, or both
m.ab <- m.ab %>%
  mutate(inf = ifelse((coalesce(quantity, 0) > threshold_cutoff | coalesce(tes, 0) > pathology_cutoff), 1, 0))%>%
  ungroup()


#ever inf during primary infection
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(inf_prim = ifelse(dpi < 42 & any(coalesce(inf, 0) == 1), 1, 0)) %>%
  ungroup()

#ever inf during secondary infection
# m.ab <- m.ab %>%
#   group_by(band_number) %>%
#   mutate(inf_sec = ifelse(dpi > 42 & any(coalesce(inf, 0) == 1), 1, 0)) %>%
#   ungroup()

m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(
    # Check if any infection occurred after dpi 42
    inf_after_dpi42 = any(dpi > 42 & inf == 1),
    # Propagate the inf_after_dpi42 value to all instances within the group
    inf_sec = ifelse(inf_after_dpi42, 1, 0)
  ) %>%
  ungroup() %>%
  dplyr::select(-inf_after_dpi42)  # Remove the intermediate column

#Rules for infection: We defined a bird as infected if it had eye score > 0, pathogen load > 50 copies, or both
ggplot(m.ab, aes(x=dpi, y=tes, color=primary_treatment))+
  geom_jitter(height=0)+
  facet_wrap(~inf)

ggplot(m.ab, aes(x=dpi, y=log10(quantity1), color=primary_treatment))+
  geom_jitter(height=0)+
  geom_hline(yintercept=log10(50))+
  facet_wrap(~inf)

ggplot(m.ab, aes(x=tes, y=log10(quantity1), color=primary_treatment))+
  geom_point(height=0)+
  facet_wrap(~inf)

ggplot(m.ab, aes(x=dpi, y=tes, color=primary_treatment))+
  geom_jitter(height=0)+
  facet_wrap(~diseased)

#secondary
ggplot(m.ab, aes(x=dpi, y=tes, color=primary_treatment))+
  geom_jitter(height=0)+
  facet_grid(~inf_sec~dpi)

ggplot(m.ab, aes(x=dpi, y=log10(quantity+1), color=primary_treatment))+
  geom_jitter(height=0)+
  geom_hline(yintercept=log10(50))+
  facet_wrap(~inf_sec)

ggplot(m.ab%>% filter(dpi > 41), aes(x=tes, y=quantity, color=primary_treatment))+
  geom_point(height=0)+
    geom_hline(yintercept=50)+
  facet_wrap(~inf_sec)

whoelse<- m.ab%>%
  filter(dpi > 41 & inf_sec==0 & quantity>50)

whoelse
```

```{r Eye Score Formatting}
#primary
ggplot(m.ab %>% filter(dpi < 42), aes(x=tes, y=log10(quantity1), color=fct_rev(as.factor(primary_dose))))+
  geom_jitter(height=0.1, width=0.1, alpha=0.5)+
  scale_color_manual(values=c(pri_colors))+
  geom_path(aes(groups=band_number))+
  theme_minimal()+
  facet_wrap(~inf_prim)

#secondary
ggplot(m.ab %>% filter(dpi > 42), aes(x=tes, y=log10(quantity1), color=as.factor(secondary_dose)))+
  geom_jitter(height=0.1, width=0.1, alpha=0.5)+
  scale_color_manual(values=c(sec_colors))+
    geom_path(aes(groups=band_number), linetype="solid")+
  coord_flip()+
  theme_minimal()+
  facet_grid(~primary_dose~inf_sec)
```
```{r Omit Birds}
#check for seropositive birds from quarantine from dataset
m.ab %>%
  filter(dpi == -8) %>%
  filter(elisa_od >= 0.061)%>%
  dplyr::select(band_number, elisa_od, primary_treatment, secondary_treatment, inf, seropos, dpi, ELISA.Run.Date)

#omit 2505 from data set for analysis as it was positive at quarantine
m.ab <- m.ab %>%
  filter(band_number != 2505)

#which birds are seropositive but qPCR negative?
m.ab%>%
  filter(infected_prim == 0 & elisa_od > 0.061 & dpi < 42)%>%
  dplyr::select(band_number, dpi, tes, elisa_od, quantity, primary_treatment)

#omit birds that were not recovered by secondary infection: 2274, 2514, 2469, 2520
not_recovered <- m.ab %>% 
  filter(band_number %in% c(2274, 2514, 2469, 2520, 2494))

#confirm quantity > cutoff at dpi 41
ggplot(not_recovered, aes(x=dpi, y=quantity, color=band_number))+
  geom_point()+
  geom_path()+
  facet_wrap(~band_number)+
  ylim(min=0, max=700)
```

General overview of antibody responses
```{r Overview of Antibody Responses Primary, warning=FALSE O}
ggplot(m.ab %>% filter(dpi <= 41), aes(x=dpi, y=elisa_od, color=fct_rev(primary_treatment)))+
  geom_point()+
  geom_hline(yintercept = 0.061)+
  stat_smooth(aes(x=dpi, y=elisa_od, group=band_number), alpha=0.5, size=0.5, span=1)+
  scale_color_manual(values = pri_colors)+
  labs(x="Days Post Infection", y="Antibody Levels", color="Primary Treatment")+
  facet_wrap(~primary_treatment)


plot <- m.ab %>%
  filter(dpi %in% c(-8, 14, 41))

ggplot(plot, aes(x = dpi, y = elisa_od, color = fct_rev(primary_treatment))) +
  geom_point() +
  geom_hline(yintercept = 0.061, linetype="dashed") +
  geom_line(aes(group=band_number), alpha = 0.1, size = 0.5) +
  stat_summary(aes(group=primary_treatment), geom="line", fun="mean", alpha=1, size=0.5, color="black")+
  stat_summary(aes(group=primary_treatment), geom="line", fun="mean", alpha=0.75, size=1)+
  scale_color_manual(values = pri_colors) +
  labs(x = "Days Post Infection", y = "Antibody Levels", color = "Primary Treatment")+
  theme_minimal()

```
Duration of disease based off of eye score during primary infection
Does primary dose predict the duration of pathology?
```{r primary disease duration}
m.ab$dpi <- as.numeric(m.ab$dpi)
d.ab <- m.ab %>%
  filter(dpi < 42 & dpi > 0) %>%
  dplyr::select(band_number, dpi, primary_treatment, sex, inf, quantity, diseased)
d.ab

ggplot(d.ab, aes(x=dpi, y=inf))+
  geom_jitter(height = 0, width=1, alpha=0.5)+
  facet_wrap(~primary_treatment)

m.ab %>% 
  filter(dpi == 41 & inf == 1)

m.ab %>%
  group_by(band_number) %>%
  summarize(inf_count = sum(inf == 1, na.rm = TRUE))

m.ab %>%
  filter(dpi <= 41)%>%
  group_by(band_number, primary_treatment, sex) %>%
  summarize(a=first(dpi[diseased == 1]),
            b=last(dpi[diseased == 1]))

diseased_duration <- m.ab %>%
  filter(dpi <=41)%>%
  group_by(band_number, primary_treatment, sex) %>%
  summarize(diseased_duration = ifelse(sum(diseased == 1) == 0, 0, last(dpi[diseased == 1] + 1) - first(dpi[diseased == 1]))) #add 1 to last diseased to account for birds that only had eye score for 1 day (dpi 7 is first and last eye score > would come up as 0, but had an eye score for at least one day)
diseased_duration
diseased_duration$diseased_duration <- as.numeric(diseased_duration$diseased_duration)


hist(diseased_duration$diseased_duration, breaks = 41)

#histogram showing length with eye score > 0 during primary infection
g.primary.duration <- ggplot(diseased_duration, aes(x=diseased_duration))+
  geom_histogram(aes(fill=fct_rev(primary_treatment)), position="dodge", bins = 48)+
  labs(title = "Duration of Pathology: Primary Infection", x="Duration of Pathology", y="Count", fill="Primary Treatment")
g.primary.duration

#does primary treatment predict disease duration?

lm.dd <- glm.nb(diseased_duration ~ primary_treatment, data=diseased_duration)
summary(lm.dd)
simulateResiduals(lm.dd, plot=T)
emm_r <- emmeans(lm.dd, ~primary_treatment)
pairs(emm_r)

lm.dd.s <- glm.nb(diseased_duration ~ primary_treatment+sex, data=diseased_duration)
summary(lm.dd.s)
dat.new = expand.grid(diseased_duration=seq(from = min(diseased_duration$diseased_duration),
                                                 to = max(diseased_duration$diseased_duration), length.out=40),
                      primary_treatment = unique(diseased_duration$primary_treatment),
                      sex=unique(diseased_duration$sex))
dat.new$yhat = predict(lm.dd, type="response", newdata=dat.new)
preds = predict(lm.dd, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(lm.dd)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit-(2*se.fit)))


#boxplot of disease duration with model predictions
ggplot(diseased_duration, aes(x=diseased_duration, y=primary_treatment, color=fct_rev(primary_treatment)))+
  #geom_boxplot(width=0.05, outlier.shape = NA)+
  geom_point(data=dat.new, aes(x=yhat, y = primary_treatment), color="black")+
  geom_errorbar(data=dat.new, aes(xmin=Lower, xmax = Upper, x=yhat, y=primary_treatment), color="black", width=0)+
  geom_jitter(height=0.25, alpha=0.3)+
  labs(title = "Duration of Pathology: Primary Infection", x="Duration of Pathology (Days)", y="Primary Treatment", color="Primary Treatment")+
  scale_color_manual(values=c(pri_colors))+
  #facet_wrap(~sex)+
  theme_minimal()


```
####Does Inoculation Dose Predict Antibody Levels?####
-----
```{r New df p.ab for primary }
#data frame with only primary infection (no PID 56)

p.ab <- m.ab %>%
  filter(dpi <=41)
```

I use a gamma distribution for the antibody data
With models spanning multiple days, band_number is included as a random effect

Do I use a log link function or inverse link function? Compare AIC and logLik
Skipping ahead here with models, but showing that *inverse link works better*

Baseline antibody levels were not significantly different from each other before inoculation.

emmeans shows estimated marginal means for variables and allows for post-hoc pairwise comparisons using the Tukey-Kramer method to minimize type 1 error.
```{r Baseline antibody levels were not significantly different}
lm0 <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi <0), family=Gamma())
summary(lm0)
plot(allEffects(lm0))

emm_r <- emmeans(lm0, ~primary_treatment)
pairs(emm_r)

```

Using primary_treatment (categorical), I show that birds inoculated with MG produce antibodies in a dose-dependent manner.

Across all days primary infection, inoculation dose 
```{r All days with model predictions}
p.ab$dpi.f <- as.factor(p.ab$dpi)
p.abt <- p.ab %>%
  filter(dpi.f %in% c(-8, 14, 41))
hist(p.abt$elisa_od)
lm1 <- glmer(elisa_od~primary_treatment + dpi + (1|band_number), data=p.abt, family=Gamma())
lm1.5 <- glmmTMB(elisa_od~primary_treatment  + primary_treatment:dpi.f + (1|band_number), data=p.abt, family=Gamma()) 
lm1.75 <- glmmTMB(elisa_od~ primary_treatment*dpi.f + (1|band_number), data=p.abt, family=Gamma(log)) 
#fully interactive does not converge with inverse link- only log link
summary(lm1.5)
summary(lm1.75)
car::Anova(lm1.75, type = "III")
simulateResiduals(lm1.75, plot=T) #but residuals look terrible with log link
hist(resid(lm1.5))
qqnorm(resid(lm1.5))

#model comparison 
p1 <- glmmTMB(elisa_od~primary_treatment + dpi.f + (1|band_number), data=p.abt, family=Gamma())
p1.5 <- glmmTMB(elisa_od~primary_treatment + primary_treatment:dpi.f + (1|band_number), data=p.abt, family=Gamma())
p1.75 <- glmmTMB(elisa_od~primary_treatment*dpi.f + (1|band_number), data=p.abt, family=Gamma())
p2<- glmmTMB(elisa_od~primary_treatment + sex + dpi.f + (1|band_number), data=p.abt, family=Gamma())
p2.5<- glmmTMB(elisa_od~primary_treatment + sex + primary_treatment:dpi.f + (1|band_number), data=p.abt, family=Gamma())
p3<- glmmTMB(elisa_od~primary_treatment * sex + dpi.f + (1|band_number), data=p.abt, family=Gamma())
p3.5 <- glmmTMB(elisa_od ~ primary_treatment:sex + dpi.f + (1|band_number), data=p.abt, family=Gamma())
p4 <- glmmTMB(elisa_od~1 + dpi.f + (1|band_number), data=p.abt, family=Gamma())

aictab(cand.set=list(p1, p1.5, p1.75, p2, p2.5, p3, p3.5, p4), modnames=c("p1", "p1.5", "p1.75", "p2","p2.5", "p3", "p3.5", "p4"))

emm_results <- emmeans(lm1.75, ~ primary_treatment*dpi.f, scale="response")
pairs(emm_results)
summary(p1.75)
summary(p3)

#specify model to predict
mod.pred <- lm1.75
#Model predictions
dat.new=expand.grid(primary_treatment=unique(p.abt$primary_treatment),
                    elisa_od = unique(p.abt$elisa_od),
                    dpi.f = unique(p.abt$dpi.f),
                    sex = unique(p.abt$sex))#new grid to put predictions into
dat.new$yhat = predict(mod.pred, type="response", newdata=dat.new, re.form=NA)
preds = predict(mod.pred, type="link", newdata=dat.new, se.fit=TRUE, re.form=NA)
dat.new = cbind(dat.new, preds)

ilink <- family(mod.pred)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))
head(dat.new)


#antibodies across all days connected primary infection with model predictions
ggplot(data=p.abt, aes(x=dpi.f, y= elisa_od,
                      color=fct_rev(primary_treatment)))+
  #geom_boxplot(outlier.shape = NA)+
  geom_hline(yintercept = 0.061, linetype="dashed", alpha=0.25)+
  geom_jitter(size=2, alpha=0.5, width=0, height=0)+
  geom_line(aes(x=dpi.f, y=elisa_od, group = as.factor(band_number)), alpha=0.1)+
  #geom_path(data=dat.new, aes(x=dpi.f, y=yhat, group=primary_treatment), color="black")+
  geom_errorbar(data=dat.new, aes(ymin=Lower, ymax = Upper, x=dpi.f, y=yhat), color="black", width=0.1)+
  #stat_summary(aes(group=primary_treatment, shape = primary_treatment), fun.y=mean, geom="point", shape=3, size=1.5, stroke=1.5, color="black")+
  stat_summary(aes(group=primary_treatment, shape = primary_treatment), fun.y=mean, geom="point", shape=3, size=2.5, stroke=1.5, alpha=1)+
  #stat_summary(aes(group=primary_treatment), fun=mean, geom="line", color="black", size=0.5, alpha=1)+
  stat_summary(aes(group=primary_treatment), fun=mean, geom="line", alpha=0.75, size=1)+  
  geom_point(data=dat.new, aes(x=dpi.f, y=yhat, color=fct_rev(primary_treatment)), size=3, alpha=0.75, shape =16)+
  geom_point(data=dat.new, aes(x=dpi.f, y=yhat), color="black", size=3, alpha=1, shape=1, stroke=0.1)+
    labs(title = "Antibody Levels Primary Infection", y="Antibody Levels", 
       x= "Days Post Infection", shape="Primary Treatment", color="Primary Treatment")+
  scale_color_manual(values=c(pri_colors))+
  #facet_wrap(~sex)+
  theme_minimal()

#antibodies across all days primary infection with model predictions
ab.all <- ggplot(data=p.abt, aes(x=dpi.f, y= elisa_od, 
                      color=fct_rev(primary_treatment)))+
  geom_hline(yintercept = 0.061, linetype="dashed", alpha=0.25)+
  geom_jitter(position = position_jitterdodge(dodge.width = 0.75, jitter.width=0.4), aes(group = fct_rev(primary_treatment)), size=2, alpha=0.5)+
      geom_jitter(data=dat.new, position = position_dodge(width=0.75), aes(x=dpi.f, y=yhat, group = fct_rev(primary_treatment)), color="black", size=5, alpha=1, shape="-", stroke=0.25)+
   geom_errorbar(data=dat.new,  position = position_dodge(width=0.75), aes(ymin=Lower, ymax = Upper, x=dpi.f, y=yhat, group=fct_rev(primary_treatment)), color="black", width=0.4)+  
    labs(y="Antibody Levels", 
       x= "Days Post Infection", shape="Primary Treatment", color="Primary Treatment")+
  scale_color_manual(values=c(pri_colors))+
  #facet_wrap(~sex)+
  theme_minimal()

ab.all

#ggsave('ab_all_prim.jpeg', width=6, height=4, units='in')

```

```{r Antibody levels on day 14 post infection were sig different between groups, fig.height=6, fig.width=10}
#Final Model
lm2 <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi == 14), family=Gamma())
summary(lm2)

emm_results <- emmeans(lm2, ~ primary_treatment, scale="response")
emm_results
pairs(emm_results)

plot(allEffects(lm2))

#model comparison
pr1 <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi == 14), family=Gamma())
pr2<- glmmTMB(elisa_od~primary_treatment + sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
pr3<- glmmTMB(elisa_od~primary_treatment * sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
pr4 <- glmmTMB(elisa_od~primary_treatment * room , data=p.ab %>% filter(dpi == 14), family=Gamma())
pr5 <- glmmTMB(elisa_od~1, data=p.ab %>% filter(dpi == 14), family=Gamma())
pr6 <- glmmTMB(elisa_od~primary_treatment + mass, data=p.ab %>% filter(dpi == 14), family=Gamma())
pr7 <- glmmTMB(elisa_od~primary_treatment + room , data=p.ab %>% filter(dpi == 14), family=Gamma())

#AICc
aictab(cand.set=list(pr1, pr2, pr3, pr4, pr5, pr6, pr7), modnames=c("pr1","pr2", "pr3", "pr4", "pr5", "pr6", "pr7"))

lm2.sex <- glmmTMB(elisa_od~primary_treatment+sex, data=p.ab %>% filter(dpi == 14), family=Gamma())
summary(lm2.sex)


#There were 15 blood samples that were lost before they were run and are not included in this graph
missing_samples <- p.ab %>%
  filter(dpi %in% c(-8, 14, 41) & is.na(elisa_od)) %>%
  dplyr::select(band_number, bird_ID, dpi, elisa_od)
print(missing_samples)

#Model predictions
mod.pred <- lm2
dat.new=expand.grid(primary_treatment=unique(p.ab$primary_treatment),
                    sex = unique(p.ab$sex))#new grid to put predictions into
dat.new$yhat = predict(mod.pred, type="response", newdata=dat.new, re.form=NA) #predicted values based off lm2 model
preds = predict(mod.pred, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(mod.pred)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))
head(dat.new)

#graph showing antibody levels on day 14 post-infection with model predictions
pid14.pred <- ggplot(data=p.ab %>% filter(dpi == 14), aes(x=primary_treatment, y=elisa_od, color=fct_rev(primary_treatment)))+
  geom_jitter(size=2, width=0.1, alpha=0.75)+
  geom_point(data=dat.new, aes(x=primary_treatment, y=yhat), size=10, shape="-", color="black")+#model predictions
  geom_errorbar(data=dat.new, aes(ymin=Lower, ymax=Upper, x=primary_treatment, y=yhat), color="black", width=0.2)+
  scale_color_manual(values = c(pri_colors))+
  geom_hline(yintercept=0.061, linetype="dashed", alpha=0.5)+
  labs(x="Primary Treatment", y="Antibody Levels", color="Primary Treatment")+
  guides(shape=FALSE)+
  #facet_wrap(~sex)+
  theme_minimal()

pid14.pred

```
I also looked at primary_dose, a continuous variable to test whether inoculation dose affects antibody response.

```{r Primary Dose Continuous Day 14}
#model comparison
prd1 <- glm(elisa_od~primary_dose, data=p.ab %>% filter(dpi == 14), family=Gamma())
prd2<- glm(elisa_od~primary_dose + sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd2.5<- glm(elisa_od~primary_dose * sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd3 <- glm(elisa_od~primary_dose + room , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd4 <- glm(elisa_od~primary_dose * room , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd5 <- glm(elisa_od~1, data=p.ab %>% filter(dpi == 14), family=Gamma())
prd6 <- glm(elisa_od~primary_dose + mass, data=p.ab %>% filter(dpi == 14), family=Gamma())

#AICc
aictab(cand.set=list(prd1, prd2, prd2.5, prd3, prd4, prd5, prd6), modnames=c("prd1", "prd2", "prd2.5", "prd3", "prd4", "prd5", "prd6"))

summary(prd1)

#continuous model predictions
dat.new2 <- data.frame(primary_dose = seq(min(p.ab$primary_dose), max(p.ab$primary_dose), length.out = 100))
dat.new2$yhat <- predict(prd1, type = "response", newdata = dat.new2)
preds = predict(prd1, type="link", newdata=dat.new2, se.fit=T)
dat.new2 = cbind(dat.new2, preds)

ilink <- family(prd1)$linkinv
dat.new2 <- transform(dat.new2,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))
head(dat.new2)

#plot continuous predicted values over raw data
pid14.dose.pred.c <- ggplot(data=p.ab %>% filter(dpi == 14), aes(x=primary_dose, y=elisa_od))+
  geom_jitter(size=2, width=0.5, aes(color=as.factor(primary_dose)))+
  geom_line(data=dat.new2, aes(x=primary_dose, y=yhat), color="black")+#model predictions
  geom_ribbon(data=dat.new2, aes(ymin=Lower, ymax=Upper, x=primary_dose, y=yhat), fill="gray", alpha=0.25)+
  scale_color_manual(values=c(pri_colors))+
  labs(x="Primary Dose", y="Antibody Levels", color="Primary Dose")+
  theme_minimal()

pid14.dose.pred.c
```
Alternatively, I can subset the primary_dose into facors based on primary_dose. This maintains the continuous nature of the data, but allows for pairwise comparisons using emmeans.
```{r Primary Dose continuous pairwise comparisons day 14}
# Create a new factor variable based on primary_dose
p.ab <- p.ab %>% mutate(primary_dose_group = cut(primary_dose, breaks = c(-Inf, 100, 2000, Inf), labels = c("Sham", "Low", "High")))

# Fit glm with  new factor variable
prdc1 <- glm(elisa_od ~ primary_dose_group, data = p.ab %>% filter(dpi == 14), family = Gamma())

# Calculate estimated marginal means (EMMs)
emm_results <- emmeans(prdc1, specs = "primary_dose_group")

# Conduct pairwise comparisons between the groups
pairs(emm_results)

```

```{r change from baseline to day 14}
# Simplify data set so pivot_wider works
m.ab.w <- m.ab %>% 
  dplyr::select(dpi, band_number, primary_treatment, secondary_dose,
                          sex, elisa_od, inf_sec)%>%
  filter(dpi %in% c(-8, 14, 41))

wibird <- m.ab.w %>% pivot_wider(names_from = dpi,
                                names_glue = "{.value}_{dpi}",
                                values_from = elisa_od)

wibird$elisa_od_pre <- wibird$`elisa_od_-8`
wibird <- wibird %>% mutate(elisa_diff = abs(elisa_od_pre - elisa_od_14))
wibird <- wibird %>% mutate(totalTES = sum())
wibird$elisa_diff1 <- wibird$elisa_diff + 0.00001

lm.change <- glm(elisa_diff1 ~ primary_treatment, data=wibird, family=Gamma())
summary(lm.change)
resid <- simulateResiduals(lm.change)
plot(resid)
plot(allEffects(lm.change))

emm_results<- emmeans(lm.change, ~ primary_treatment)
pairs(emm_results)
#Model predictions
mod.pred <- lm.change
dat.new=expand.grid(primary_treatment=unique(wibird$primary_treatment),
                    sex = unique(wibird$sex))#new grid to put predictions into
dat.new$yhat = predict(mod.pred, type="response", newdata=dat.new, re.form=NA) #predicted values based off lm2 model
preds = predict(mod.pred, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(mod.pred)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))

ggplot(wibird, aes(x=primary_treatment, y=elisa_diff, color=fct_rev(primary_treatment)))+
  geom_jitter(width=0.25, height=0, alpha=0.5)+
  scale_color_manual(values = c(pri_colors))+
  geom_point(data = dat.new, aes(x=primary_treatment, y=yhat, color=fct_rev(primary_treatment)), size=2, color='black')+
  geom_errorbar(data= dat.new, aes(ymin=Lower, ymax=Upper, x= primary_treatment, y=yhat), color='black', width=0.2)+
  labs(x="Day Post Infection", y="Change in Antibody Levels", color="Primary Treatment", shape = "Primary Treatment", title = "Change in Antibody Levels: Day 14 - Baseline")+
  theme_minimal()


```


```{r Does antibody change predict susceptibility}
#does antibody change from baseline to 14 predict susceptibility upon secondary infection?
wibird
glm.abch <- glm(inf_sec ~ elisa_diff + secondary_dose, data=wibird, family=binomial())
glm.ab14<- glm(inf_sec ~ elisa_od_14 + secondary_dose, data=wibird, family=binomial())
summary(glm.ab14)
 simulateResiduals(glm.abch, plot=T)
 car::Anova(glm.abch, type="III")
car::Anova(glm.ab14, type="III")
 emm_results<- emmeans(glm.abch, ~ secondary_dose)
pairs(emm_results)
# #continuous model predictions
# dat.new <- data.frame(elisa_diff = unique(wibird$elisa_diff),
#                        secondary_dose= seq(min(wibird$secondary_dose), max(wibird$secondary_dose), length.out = 10)
#                       )
# dat.new$yhat <- predict(glm.abch, type = "response", interval = "confidence", level = 0.95, newdata = dat.new)

#continuous model predictions
ggplot(wibird, aes(x=elisa_od_14, y=inf_sec, color=fct_rev(primary_treatment)))+
  geom_point()+
  #geom_line(data=dat.new, aes(x=elisa_diff, y=yhat))+
  theme_minimal()



```


Antibody levels return to baseline in the low (p = 0.149), but not high dose (p < 0.001) groups by day 41.
```{r Antibody levels on day 41 post infection were sig different between groups}
lm3 <- glm(elisa_od~primary_treatment, data=p.ab %>% filter(dpi==41), family=Gamma())
summary(lm3)

emm_results<- emmeans(lm3, ~ primary_treatment)
pairs(emm_results)

#model comparison
p1 <- glm(elisa_od~primary_treatment, data=p.ab %>% filter(dpi==41), family=Gamma())
p2<- glm(elisa_od~primary_treatment + sex , data=p.ab %>% filter(dpi==41), family=Gamma())
p3<- glm(elisa_od~primary_treatment * sex , data=p.ab %>% filter(dpi==41), family=Gamma())
p4 <- glm(elisa_od~primary_treatment + quantity , data=p.ab %>% filter(dpi==41), family=Gamma())
p5 <- glm(elisa_od~1, data=p.ab %>% filter(dpi==41), family=Gamma())
p6 <- glm(elisa_od~primary_treatment + mass, data= p.ab %>% filter(dpi==41), family=Gamma())

#AICc
aictab(cand.set=list(p1, p2, p3, p4, p5, p6), modnames=c("p1", "p2", "p3", "p4", "p5", "p6"))

summary(p2)
#p2 is the best model
#but sex adds complexity and is not significant (0.1445) so remove

#p1 is second best - use
summary(p1)

#specify model for predictions
mod.pred <- lm3

#model predictions
dat.new=expand.grid(primary_treatment=unique(p.ab$primary_treatment),
                    sex=unique(p.ab$sex))#new grid to put predictions into
dat.new$yhat = predict(mod.pred, type="response", newdata=dat.new, re.form=NA) #predicted values based off lm3  model
preds = predict(mod.pred, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(mod.pred)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))
head(dat.new)
#plot predicted values over raw data
pid41.pred <- ggplot(data = m.ab %>% filter(dpi == 41), aes(x = primary_treatment, y = elisa_od, color=fct_rev(primary_treatment))) +
  geom_jitter(size=1.5, width = 0.25) +
  geom_hline(yintercept = 0.061, color = "black", alpha = 0.75, linetype='dashed') +
  labs(x="Inoculation Dose", y= "Antibody Levels", color = "Primary Treatment")+
  geom_point(data=dat.new, aes(x=primary_treatment, y=yhat, shape=primary_treatment), size=10, shape="-", color="black")+#model predictions
  geom_errorbar(data=dat.new, aes(ymin=Lower, ymax=Upper, x=primary_treatment, y=yhat), color="black", width=0.25)+
  scale_color_manual(values = c(pri_colors))+
  guides(shape=FALSE)+
  ylim(c(0.04, 0.19))+
  facet_wrap(~sex)+
  theme_minimal()

pid41.pred

m.ab %>%
  filter(dpi %in% c(41, 14))%>%
  drop_na(elisa_od)%>%
  group_by(dpi, primary_treatment)%>%
  summarise(mean_ab = mean(elisa_od))

```

Antibody levels return to baseline in the low (p = 0.149), but not high dose (p < 0.001) groups by day 41.
```{r Primary Dose Continuous Day 41}
#model comparison
pr1 <- glm(elisa_od~primary_dose, data=p.ab %>% filter(dpi==41), family=Gamma())
pr2<- glm(elisa_od~primary_dose + sex , data=p.ab %>% filter(dpi==41), family=Gamma())
pr3<- glm(elisa_od~primary_dose * sex , data=p.ab %>% filter(dpi==41), family=Gamma())
pr4 <- glm(elisa_od~primary_dose + quantity , data=p.ab %>% filter(dpi==41), family=Gamma())
pr5 <- glm(elisa_od~1, data=p.ab %>% filter(dpi==41), family=Gamma())
pr6 <- glm(elisa_od~primary_dose + mass, data= p.ab %>% filter(dpi==41), family=Gamma())


#AICc
aictab(cand.set=list(pr1, pr2, pr3, pr4, pr5, pr6), modnames=c("pr1", "pr2", "pr3", "pr4", "pr5", "pr6"))

#pr2 best model
#but sex adds complexity and is not significant (0.146) so remove

summary(pr1)

#continuous model predictions
dat.newer2 <- data.frame(primary_dose = seq(min(p.ab$primary_dose), max(p.ab$primary_dose), length.out = 100))
dat.newer2$yhat <- predict(pr1, type = "response", interval = "confidence", level = 0.95, newdata = dat.newer2)
head(dat.newer2)

pid41.dose.pred.c <- ggplot(data=p.ab %>% filter(dpi == 41), aes(x=primary_dose, y=elisa_od))+
  geom_jitter(size=2, width=0.1)+
  geom_line(data=dat.newer2, aes(x=primary_dose, y=yhat), color="brown")+#model predictions
  labs(title = "ELISA OD PID 41", x="Primary Dose", y="ELISA OD", shape="Primary Dose")+
  geom_hline(yintercept = 0.061, color = "black", alpha = 0.75, linetype='dashed')

pid41.dose.pred.c

#pairwise comparisons
p.ab <- p.ab %>% mutate(primary_dose_group = cut(primary_dose, breaks = c(-Inf, 100, 2000, Inf), labels = c("Sham", "Low", "High")))

# Fit glm with  new factor variable
pr1 <- glm(elisa_od~primary_dose_group, data=p.ab %>% filter(dpi==41), family=Gamma())

# Calculate estimated marginal means (EMMs)
emm_results <- emmeans(pr1, specs = "primary_dose_group")

# Conduct pairwise comparisons between the groups
pairs(emm_results)

```





Does prior exposure induce heterogeneity in antibody levels?####
```{r Does prior exposure induce heterogeneity in antibody levels?, fig.height=6, fig.width=10}
p.ab <- p.ab %>%
  filter(dpi !=56)
#subset antibodies by groups to look at their variance
#subset by primary treatment (number doesn't matter) with 1|band_number as random effect
#variance of random effect should be highest in highest heterogeneity groups


#across all primary infection days, which groups are most heterogeneous?
glm.all <- glmer(elisa_od~1 +(1|band_number), data=p.ab, family=Gamma())
glm.sham <- glmer(elisa_od~1 +(1|band_number), data=subset(p.ab, primary_treatment == "Sham"), family=Gamma())
glm.low <- glmer(elisa_od~1 +(1|band_number), data=subset(p.ab, primary_treatment == "Low"), family=Gamma())
glm.high <- glmer(elisa_od~1 +(1|band_number), data=subset(p.ab, primary_treatment == "High"), family=Gamma())

summary(glm.all); summary(glm.sham); summary(glm.low); summary(glm.high)

AIC(glm.sham,glm.low, glm.high)

##Days 14 and 41 only
#var <- c(11.5496, 0.284649, 8.65716, 5.8528) #variance from table above
#ci <- c(3.39885, 0.534, 2.9423, 2.4192) #Standard Deviation from table above
#g <- c("All", "Sham", "Low", "High") #Groups

##Days -8, 14, and 41 
var <- c(10.89235, 0.267613, 7.58692, 5.2232) #variance from table above
ci <- c(3.3004, 0.51731, 2.7544, 2.2854) #Standard Deviation from table above
g <- c("All", "Sham", "Low", "High") #Groups

#new df with variance and error for error bars (min/max)
variability <- data.frame(g,var, ci)

g.var.primary <- ggplot(variability %>% filter(g != "All"), aes(x=fct_rev(g), y=ci, color=g))+
  geom_point(size=5)+
  #geom_errorbar(aes(ymin=min, ymax=max), width=0.5)+ #add errorbars representing +/- 1 SD
  labs(title = "Primary Infection Variation in Antibody Levels", x="Primary Treatment", y="Standard Deviation", color="Treatment")+
  scale_color_manual(values=c(pri_colors))+
  theme_minimal()

g.var.primary

```
(chatGPT)
In a mixed-effects model, the random effects capture variability among groups or clusters in the data. The variance component represents the variability of the random effects, while the standard deviation is the square root of the variance.

Mathematically, the standard deviation (σ) is the square root of the variance (σ^2), so σ = √(variance).

For example, if the variance of the random effects for a certain grouping factor is 5.2232, as in your model summary, then the standard deviation would be approximately √5.2232 ≈ 2.2854, as also shown in the summary output.

So, in summary, the standard deviation provides a more interpretable measure of the dispersion of the random effects compared to the variance, as it is in the same units as the original data.

Residual Models: Method to look at the amount of variance within each treatment group while accounting for variance from differences in dpi






Histograms
```{r Histograms}
#Add variable indicating the elisa_od mean for each primary_treatment
p.ab <- p.ab %>%
  group_by(primary_treatment)%>%
  mutate(groupmean = mean(elisa_od))

#Add variable indicating the elisa_od mean for each primary_treatment
p.ab <- p.ab %>%
  group_by(primary_treatment, dpi)%>%
  mutate(groupmean.dpi = mean(elisa_od))

#Histogram showing distribution of elisa_od across all sample days by primary_treatment
ggplot(p.ab%>% filter(dpi != -8), aes(x=elisa_od, fill=fct_rev(primary_treatment)))+
  #geom_density(color="black", alpha=0.5)+
  geom_histogram(binwidth = 0.005, position="identity", alpha=2, color="black", size=0.35)+
  geom_vline(xintercept=0.061, linetype="dashed", alpha=0.5)+
  xlim(c(0.04, 0.19))+
  geom_vline(data = p.ab %>% filter(dpi != -8), aes(xintercept = groupmean, color = "red"), linetype = "dotted",alpha = 1, show.legend=FALSE) +
  labs(y= "Count", x= "Antibody Levels", fill="Primary Treatment", color= "Average OD")+
  #scale_fill_manual(values=c( "white", "gray","black"), labels=treat_names)+
  scale_color_manual(values = c("red"), guide = guide_legend(title= NULL))+
  facet_grid(~primary_treatment~dpi)

#Histogram showing mean of infected birds
ggplot(p.ab%>% filter(dpi != -8 & inf_prim == 1), aes(x=elisa_od, fill=fct_rev(primary_treatment)))+
  geom_histogram(binwidth = 0.005, position="identity", alpha=2, color="black", size=0.35)+
  #geom_density(alpha=0.25)+
  geom_vline(xintercept=0.061, linetype="dashed", alpha=0.5)+
  xlim(c(0.04, 0.19))+
  geom_vline(data = p.ab%>% filter(dpi != -8), aes(xintercept = groupmean.dpi, color = "red"), linetype = "dotted",alpha = 1, show.legend=FALSE) +
  labs(y= "Count", x= "Antibody Levels", fill="Primary Treatment", color= "Average OD")+
  #scale_fill_manual(values=c("black", "gray", "white"), labels=treat_names)+
  scale_color_manual(values = c("red"), guide = guide_legend(title= NULL))+
  facet_grid(~primary_treatment~dpi)

#uninfected birds
ggplot(p.ab%>% filter(dpi != -8 & inf_prim == 0), aes(x=elisa_od, fill=fct_rev(primary_treatment)))+
  geom_histogram(binwidth = 0.005, position="identity", alpha=2, color="black", size=0.35)+
  #geom_density(alpha=0.25)+
  geom_vline(xintercept=0.061, linetype="dashed", alpha=0.5)+
  xlim(c(0.04, 0.19))+
  geom_vline(data = p.ab%>% filter(dpi != -8), aes(xintercept = groupmean.dpi, color = "red"), linetype = "dotted",alpha = 1, show.legend=FALSE) +
  labs(y= "Count", x= "Antibody Levels", fill="Primary Treatment", color= "Average OD")+
  #scale_fill_manual(values=c("black", "gray", "white"), labels=treat_names)+
  scale_color_manual(values = c("red"), guide = guide_legend(title= NULL))+
  facet_grid(~primary_treatment~dpi)
```

Coefficient of Variation: Primary Dose
```{r Coefficient of Variation}
#calculate CV
m.cv.all <- p.ab %>% 
  group_by(primary_treatment)%>%
  drop_na(elisa_od)%>%
  summarise(bird_cv = sd(elisa_od)/mean(elisa_od), #this is variation within groups 
            bird_sd = sd(elisa_od))

#Calculate CV each day
m.cv <- p.ab %>% 
  group_by(dpi, primary_treatment)%>%
    drop_na(elisa_od)%>%
  summarise(bird_cv = sd(elisa_od)/mean(elisa_od),
            bird_sd = sd(elisa_od))

#Calculate CV each day
m.cv.s <- p.ab %>% 
  group_by(dpi, primary_treatment, sex)%>%
    drop_na(elisa_od)%>%
  summarise(bird_cv = sd(elisa_od)/mean(elisa_od),
            bird_sd = sd(elisa_od))

#Graph of CV calculated from dpi -8 to 41 with error bars +/- 1 SD
cv.all.primary <- ggplot(m.cv.all, aes(x=primary_treatment, y=bird_cv, color=fct_rev(primary_treatment)))+
  geom_point(size=3)+
  labs(title="CV of Antibody Levels Across Primary Infection", x="Primary Treatment", y="CV", color="Treatment")
  #scale_fill_manual(values=c( "gray90", "gray50", "gray25"))

cv.all.primary

cv.primary <- ggplot(m.cv, aes(x=primary_treatment, y=bird_cv, color=fct_rev(primary_treatment)))+
  geom_point(size=3)+
  labs(x="Primary Treatment", y="CV", color="Primary Treatment")+
  facet_wrap(~dpi, ncol=3)

cv.primary

ggplot(m.cv, aes(x=dpi, y=bird_cv, color=fct_rev(primary_treatment)))+
  geom_point(size=2)+
  geom_line()+
  labs(x="Primary Treatment", y="CV", color="Primary Treatment")

#by sex
ggplot(m.cv.s, aes(x=dpi, y=bird_cv, color=fct_rev(primary_treatment)))+
  geom_point(size=2)+
  geom_line()+
  labs(x="Primary Treatment", y="CV", color="Primary Treatment")+
  facet_wrap(~sex)

```
Proportional Variability
```{r Proportional Variability}
#install.packages("remotes")
#remotes::install_github("T-Engel/CValternatives")
library(CValternatives)
library(patchwork)
p.ab$tes.new <- p.ab$tes + .01
p.abi <- p.ab %>%
  filter(inf_prim == 1)%>%
  dplyr::select(dpi, primary_treatment, tes.new, elisa_od, quantity1)

#antibodies
a.cv <- p.abi %>% 
  group_by(dpi, primary_treatment)%>%
  drop_na(elisa_od)%>%
  dplyr::summarise(bird_cv = sd(elisa_od)/mean(elisa_od),
            bird_sd = sd(elisa_od),
            bird_pv = PV(elisa_od))

#eye score
e.cv <- p.abi %>% 
  group_by(dpi, primary_treatment)%>%
  summarise(bird_cv = sd(tes.new)/mean(tes.new),
            bird_sd = sd(tes.new),
            bird_pv = PV(tes.new))
#path load
q.cv <- p.abi %>% 
  group_by(dpi, primary_treatment)%>%
  drop_na(quantity1)%>%
  summarise(bird_cv = sd(quantity1)/mean(quantity1),
            bird_sd = sd(quantity1),
            bird_pv = PV(quantity1))

#path load
qpv <- ggplot(q.cv, aes(x=dpi, y=bird_pv))+
  geom_point(aes(color=fct_rev(primary_treatment)))
qpv

#antibody pv
pv <- ggplot(a.cv, aes(x=dpi, y=bird_pv))+
  geom_point(aes(color=fct_rev(primary_treatment)))

#antibody cv
cv <- ggplot(a.cv, aes(x=dpi, y=bird_cv))+
  geom_point(aes(color=fct_rev(primary_treatment)))

#antibody pv
pri.ab.var <- ggplot(a.cv , aes(x=dpi, y=bird_pv))+
  geom_point(aes(color=fct_rev(primary_treatment), alpha="PV"), size=3)+
  geom_line(aes(color=fct_rev(primary_treatment)))+
  geom_point(aes(x=dpi, y=bird_cv, color=fct_rev(primary_treatment), alpha = "CV"), size=3)+
  geom_line(aes(dpi, y=bird_cv, color=fct_rev(primary_treatment), alpha="CV"), linetype="dashed")+
  scale_alpha_manual(values = c(0.5,1))+
  scale_color_manual(values = c(pri_colors))+
  labs(x="Days Post Primary Inoculation", y="Variability", color="Primary Treatment", alpha = "Variability Metric")+
  theme_minimal()

pri.ab.var

ggsave('ab_var_prim.jpeg', width=6, height=4, units='in')

ggplot(a.cv, aes(x=bird_pv, y=bird_cv, color=fct_rev(primary_treatment)))+
  geom_point()+
  geom_path()

print(pv + cv)
pv
cv

m.cv
a.cv
```
```{r Heterogeneity Paper Values; Hawley et al. 2024}

dose <- c("Sham", "Low", "High")
CoV <- as.numeric(c(0.899, 1.630, 2.511))
ab.pv <- as.numeric(c(0.04156784, 0.14716858, 0.18885516))
ab.cv <- as.numeric(c(0.03997555, 0.17202405, 0.26176249))
mean_sus <- as.numeric(c(1.181, 0.446, 0.192))
mean_ab <- as.numeric(c(0.045, 0.04786, 0.0579))
dpi <- 41



het.df <- data.frame(dose, CoV, mean_sus, ab.pv, ab.cv, dpi, mean_ab)

het.df$mean_sus_inv <- 1/het.df$mean_sus
het.paper.only <- ggplot(het.df, aes(x=DPI.41))+
    geom_point(size=3,aes(x="CoV", y=CoV, color=dose), shape = 15)+
  geom_point(size=3.7,aes(x="CoV", y=CoV, shape = "CoV"), color="red", shape=0, stroke = 2)+
  scale_color_manual(values=c(pri_colors))+
  scale_y_continuous(
    name= "Variability in Susceptibility (CoV) Hawley et al. 2024"
  )+
  theme_minimal()+
  theme(
    axis.title.y = element_text(color = "red", size=12, face="bold")
  ) +
  labs(color = "Primary Treatment", shape= "Variability Metric")
het.paper.only

ab.paper.only <- ggplot(het.df, x=DPI.41)+
  geom_point(size=3,aes(x="PV", y=ab.pv, color=dose, shape = "PV"), shape=19)+
   geom_point(size=3.6,aes(x="PV", y=ab.pv), color="black", shape=1, stroke = 2)+
  scale_color_manual(values=c(pri_colors))+
  scale_y_continuous(
    name="Variability in Antibody Levels"
  )+
  theme_minimal()+
  theme(
    axis.title.y = element_text(color = "black", size=12, face = "bold")
  ) +
  labs(color = "Primary Treatment", shape= "Variability Metric")
ab.paper.only

coeff <- 10
het.paper <- ggplot(het.df)+
  geom_point(size=3,aes(x="PV", y=ab.pv*coeff, color=dose, shape = "PV"))+

  geom_point(size=3,aes(x="CV", y=ab.cv*coeff, color=dose, shape = "CV"))+

    geom_point(size=3,aes(x="CoV", y=CoV, color=dose, shape = "CoV"))+
  geom_point(size=3,aes(x="CoV", y=CoV, shape = "CoV"), color="black", shape=1, stroke = 1)+
  scale_color_manual(values=c(pri_colors))+
  scale_y_continuous(
    name= "Variability in Susceptibility (CoV) Hawley et al. 2024",
    sec.axi=sec_axis(~.*1, name="Variability in Antibody Levels * 10")
  )+
  theme_minimal()+
  theme(
    axis.title.y = element_text(color = "red", size=11),
    axis.text.y = element_text(color="red"),
    axis.text.y.right = element_text(color="black"),
    axis.title.y.right = element_text(color = "black", size=11, face = "bold")
  ) +
  labs(color = "Primary Treatment", shape= "Variability Metric", x= "Variability Metric")

#ggsave('var_sus_ab.jpeg', width=6, height=4, units='in')

#mean antibody levels
ggplot(het.df)+
  geom_point(size=3, aes(x=as.factor(dpi), y=mean_ab, shape="Mean IgG", color=dose), shape = 18)+
  geom_point(size=3, aes(x=as.factor(dpi), y=mean_ab, shape="Mean IgG"), color='black', shape = 5, stroke=1.25)+
  labs(color = "Primary Treatment", x= "Mean IgG", y="Mean Antibody Levels")+
  scale_color_manual(values=c(pri_colors))+
  theme_minimal()



#1/mean susceptibility (Hawley et al., 2024)
ggplot(het.df)+
  geom_point(size=3, aes(x=as.factor(dpi), y=mean_sus_inv, color=dose), shape = 17)+
  geom_point(size=3, aes(x=as.factor(dpi), y=mean_sus_inv), color='red', shape = 2, stroke=1.25)+
  theme_minimal()+
  theme(
    axis.title.y = element_text(color = "red", size=11),
    axis.text.y = element_text(color="red"),
  ) +
    labs(color = "Primary Treatment", x= "Days Post Inoculation", y="1/Mean Susceptibility (Hawley et al., 2024)")+
    scale_color_manual(values=c(pri_colors))
  

#scale susceptibility to ab level
het.df <- het.df %>%
  mutate(mean_sus_inv_scaled = ((mean_sus_inv - 0) / (5 - 0)) * (0.06 - 0.04) + 0.04)

ggplot(het.df)+
  geom_point(size=6, aes(x="Mean IgG", y=mean_ab, color=dose), shape = 18)+
  geom_point(size=3, aes(x="1/Mean Susceptibility", y=mean_sus_inv_scaled, color=dose), shape = 17)+
  geom_point(size=3, aes(x="1/Mean Susceptibility", y=mean_sus_inv_scaled), color='black', shape = 2, stroke=1.25)+
  scale_color_manual(values=c(pri_colors))+
  scale_y_continuous(
    name= "Scaled 1/Mean Susceptibility; Hawley et al. 2024",
    sec.axi=sec_axis(~.*1, name="Mean IgG Levels")
  )+
  theme_minimal()+
  theme(
    axis.title.y = element_text(color = "red", size=11),
    axis.text.y = element_text(color="red"),
    axis.text.y.right = element_text(color="black"),
    axis.title.y.right = element_text(color = "black", size=11, face = "bold")
  ) +
  labs(color = "Primary Treatment", shape= "Measure", x= "Mean", color="Primary Treatment")


het.paper.only
ab.paper.only
het.paper
 pri.ab.var

 library(knitr)

data <- data.frame(Dose = dose, 'Susceptibility_CV' = CoV, `Antibody_PV` = ab.pv, `Antibody_CV` = ab.cv)

data[, -1] <- round(data[, -1], 2)

data <- t(data)
# Print the dataframe with kable and kableExtra for formatting
kable(data, format = "markdown", row.names = TRUE) %>%
  kable_styling(full_width = FALSE) %>%
  kable_styling(bootstrap_options = "striped", "hover", font_size = 14, position = "center")
```

```{r variability primary - iffy}
bird.pv <- p.ab %>% 
  group_by(band_number, primary_treatment)%>%
  drop_na(elisa_od)%>%
  summarise(bird_cv = sd(elisa_od)/mean(elisa_od),
            bird_sd = sd(elisa_od),
            bird_pv = PV(elisa_od))

bird.pv

ggplot(bird.pv, aes(x=primary_treatment, y=bird_pv, color=fct_rev(primary_treatment)))+
  geom_jitter(aes(alpha="PV"), size=3)+
  geom_jitter(aes(x=primary_treatment, y=bird_cv, alpha = "CV"), size=3)+
  scale_color_manual(values=c(pri_colors))+
  labs(x="Primary Treatment", y="Variability", color="Primary Treatment", alpha = "Variability Metric")+
  theme_minimal()

hist(bird.pv$bird_pv)
bird.pv$bird_pv1 <- bird.pv$bird_pv+0.0001
mod <- glmmTMB(bird_pv1 ~ primary_treatment, data = bird.pv, family = Gamma())
summary(mod)

simulateResiduals(mod, plot=T)
emm_r <- emmeans(mod, ~primary_treatment)
pairs(emm_r)

```

----
####Secondary Inoculation####
----
```{r Remove birds that weren't recovered}
#omit from dataset - were still infected (path load) on day 41 prior to reinfection day 42
m.ab <- m.ab %>%
  filter(!(band_number %in% c(2274, 2514, 2469, 2520, 2494)))

m.ab.w <- m.ab %>% 
  dplyr::select(dpi, band_number, primary_treatment, secondary_dose,
                          sex, elisa_od, inf_sec)%>%
  filter(dpi %in% c(-8, 14, 41))

wibird <- m.ab.w %>% pivot_wider(names_from = dpi,
                                names_glue = "{.value}_{dpi}",
                                values_from = elisa_od)

wibird$elisa_od_pre <- wibird$`elisa_od_-8`
wibird <- wibird %>% mutate(elisa_diff = abs(elisa_od_pre - elisa_od_14))
wibird <- wibird %>% mutate(totalTES = sum())
wibird$elisa_diff1 <- wibird$elisa_diff + 0.00001
wibird$sec_dose.n <- wibird$secondary_dose+1
wibird$log10.sec_dose <- round(log10(wibird$sec_dose.n), digits=2)
```


Overview of secondary antibody levels
```{r Antibody levels secondary, warning=FALSE}
#primary w/ secondary colors
ggplot(m.ab %>% filter(dpi <=41), aes(x=dpi, y=elisa_od, color=as.factor(secondary_dose)))+
  geom_point()+
  geom_hline(yintercept = 0.061)+
  stat_smooth(aes(x=dpi, y=elisa_od, group=band_number), alpha=0.5, size=0.5, span=1)+
  scale_color_manual(values = sec_colors)+
  labs(x="Days Post Infection", y="Antibody Levels", color="Secondary Dose")+
  facet_wrap(~primary_treatment)

#ab levels over all experiment
ggplot(m.ab, aes(x=dpi, y=elisa_od, color=as.factor(secondary_dose)))+
  geom_point()+
  geom_hline(yintercept = 0.061)+
  stat_smooth(aes(x=dpi, y=elisa_od, group=band_number), alpha=0.5, size=0.5, span=1)+
  scale_color_manual(values = sec_colors)+
  labs(x="Days Post Infection", y="Antibody Levels", color="Secondary Dose")+
  facet_wrap(~primary_treatment)

#ab levels dpi 56
ggplot(m.ab%>%filter(dpi==56), aes(x=as.factor(secondary_dose), y=elisa_od, color=as.factor(secondary_dose)))+
  geom_hline(yintercept=0.061, linetype="dashed", alpha=0.5)+
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(aes(color=as.factor(secondary_dose)), size=1.5, shape=1, alpha=0.75)+
  labs(x="Primary Treatment", y="ELISA OD", fill="Treatment")+
  stat_summary(aes(group=secondary_dose), fun=mean, shape = 18, size=.5)+
  scale_color_manual(values=sec_colors)+
  labs(title = "Antibody Levels Post-Secondary Infection", y= "Antibody Levels", x="Secondary Dose", color="Secondary Dose", shape="Secondary Dose")+
  facet_wrap(~primary_treatment)

#birds that had MG primary then sham secondary to look at "waning" antibody levels
mg.sham <- m.ab %>%
  filter(secondary_dose == "0")

mg.sham

ggplot(mg.sham%>% filter(dpi %in% c(-8, 14, 41, 56)), aes(x=dpi, y=elisa_od, color=fct_rev(primary_treatment)))+
  geom_point()+
  geom_line(aes(group=band_number))

# ggplot(m.ab%>%filter(band_number== 2536), aes(x=tes, y=log10(quantity1), color=as.factor(dpi)))+
#   geom_point()+
#   geom_hline(yintercept=log10(50))+
#   facet_wrap(~inf_sec)
```
```{r Are antibody levels on day 14 predictive of susceptibility upon secondary challenge}
m.ab.w <- m.ab %>% 
  dplyr::select(dpi, band_number, primary_treatment, secondary_dose,
                          sex, elisa_od, inf_sec)%>%
  filter(dpi %in% c(-8, 14, 41))

wibird <- m.ab.w %>% pivot_wider(names_from = dpi,
                                names_glue = "{.value}_{dpi}",
                  values_from = elisa_od)

#could try scaling antibody levels to help w/ effect sizes: value - minimum / max - min 0 to 1
# sc.wibird <- wibird %>%
#   dplyr::select(band_number, primary_treatment, secondary_dose, inf_sec, log10.sec_dose, elisa_od_14)%>%
#   mutate(scaled_od_14 = (elisa_od_14 - min(elisa_od_14)) / (max(elisa_od_14) - min(elisa_od_14)))
# 
# wibird$scaled_od
wibird <- wibird %>% mutate(totalTES = sum())
wibird$sec_dose.n <- wibird$secondary_dose+1
wibird$log10.sec_dose <- round(log10(wibird$sec_dose.n), digits = 2)

wibird$log10.sec_dose <- as.numeric(wibird$log10.sec_dose)

glm.ab14.all <- glm(inf_sec ~ elisa_od_14*log10.sec_dose, data=wibird, family=binomial()) #Interaction is not significant
glm.ab14 <- glm(inf_sec ~ elisa_od_14 + log10.sec_dose, data=wibird, family=binomial())

AIC(glm.ab14.all, glm.ab14)
summary(glm.ab14.all)
summary(glm.ab14)
car::Anova(glm.ab14, type = 3)
simulateResiduals(glm.ab14, plot=T)

dat.new=expand.grid(log10.sec_dose=unique(wibird$log10.sec_dose),
                    inf_sec=unique(wibird$inf_sec),
                    elisa_od_14=unique(wibird$elisa_od_14))
dat.new$yhat=predict(glm.ab14, type="response", newdata = dat.new)
#prediction intervals
preds = predict(glm.ab14, type = "link", newdata = dat.new, se.fit =T)
#bind se's and fitted points
dat.new = cbind(dat.new, preds)
#inverse link function
ilink <- family(glm.ab14)$linkinv
#back transform CIs
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))

wibird$secondary_dose_fct <- factor(wibird$secondary_dose, levels = c(0, 30, 100, 300, 7000))

sec_dose_names <- c(
  "0" = "Log10(0+1)",
  "1.49" = "Log10(30+1)",
  "2" = "Log10(100+1)",
  "2.48" = "Log10(300+1)",
  "3.85" = "Log10(7000+1)"
)

ggplot(wibird, aes(x=(elisa_od_14), y=(inf_sec), color=as.factor(log10.sec_dose)))+
  geom_line(data=dat.new, aes(x=(elisa_od_14), y=yhat), alpha = 1, size =1)+
   geom_ribbon(data = dat.new, aes(ymin=Lower, ymax = Upper, x= elisa_od_14, y=yhat, fill=as.factor(log10.sec_dose)), alpha = 0.05, linetype="dashed", size=0.1) + 
    geom_point(alpha=0.5, size=2)+
  scale_color_manual(values = c(sec_colors))+
    scale_fill_manual(values = c(sec_colors))+
  labs(x="Antibody Levels Day 14", y= "Susceptibility (Infected 1|0)", color="log10(Secondary Dose + 1)", fill ="log10(Secondary Dose + 1)")+
  scale_x_continuous(name = "Antibody Levels Day 14",
                     labels = scales::number_format(accuracy = 0.01))+
  #scale_x_reverse()+
  #scale_y_reverse()+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap(~log10.sec_dose,labeller = as_labeller(sec_dose_names), nrow=1)



```

```{r Are antibody levels on day 41 predictive of susceptibility upon secondary challenge}
glm.ab41 <- glm(inf_sec ~ elisa_od_41 + log10.sec_dose, data=wibird, family=binomial())
glm.ab41.int <- glm(inf_sec ~ elisa_od_41 * log10.sec_dose, data=wibird, family=binomial())
summary(glm.ab41.int)
summary(glm.ab41)
car::Anova(glm.ab41, type = 3)
simulateResiduals(glm.ab41, plot=T)


dat.new=expand.grid(log10.sec_dose=unique(wibird$log10.sec_dose),
                    inf_sec=unique(wibird$inf_sec),
                    elisa_od_41=unique(wibird$elisa_od_41))#new grid to put predictions into
dat.new$yhat=predict(glm.ab41, type="response", newdata = dat.new)
#prediction intervals
preds = predict(glm.ab41, type = "link", newdata = dat.new, se.fit =T)
#bind se's and fitted points
dat.new = cbind(dat.new, preds)
#inverse link function
ilink <- family(glm.ab41)$linkinv
#back transform CIs
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))

ggplot(wibird, aes(x=(elisa_od_41), y=(inf_sec), color=as.factor(log10.sec_dose)))+
  geom_point(alpha=0.5)+
  geom_line(data=dat.new, aes(x=(elisa_od_41), y=yhat), alpha = 1, size =1)+
   geom_ribbon(data = dat.new, aes(ymin=Lower, ymax = Upper, x= elisa_od_41, y=yhat, fill=as.factor(log10.sec_dose)), alpha = 0.1) + 
  scale_color_manual(values = c(sec_colors))+
    scale_fill_manual(values = c(sec_colors))+
  labs(x="Antibody Levels Day 41", y= "Susceptibility (Secondary Infection 0|1)", color="log10(Secondary Dose)", fill ="log10(Secondary Dose)")+
  facet_wrap(~log10.sec_dose, nrow=1)+
  scale_x_continuous(name = "Antibody Levels Day 41",
                     labels = scales::number_format(accuracy = 0.01))+
  #scale_x_reverse()+
  theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r secondary disease duration}
diseased_duration_sec <- m.ab %>%
  filter(dpi>41)%>%
  group_by(band_number, primary_treatment, secondary_dose, sex) %>%
  summarize(diseased_duration = ifelse(sum(diseased == 1) == 0, 0, last(dpi[diseased == 1] + 1) - first(dpi[diseased == 1])))

diseased_duration_sec$log10.sec_dose <- round(log10(diseased_duration_sec$secondary_dose+1), digits = 2)

lm.dd.s <- glm.nb(diseased_duration ~ primary_treatment+log10.sec_dose, data=diseased_duration_sec)
summary(lm.dd.s)
car::Anova(lm.dd.s, type = 3)
simulateResiduals(lm.dd.s, plot=T)
emm_r <- emmeans(lm.dd.s, ~primary_treatment*log10.sec_dose)
pairs(emm_r)

dat.new = expand.grid(diseased_duration=seq(from = min(diseased_duration_sec$diseased_duration),
                                                 to = max(diseased_duration_sec$diseased_duration), length.out=40),
                      log10.sec_dose = unique(diseased_duration_sec$log10.sec_dose),
                      primary_treatment = unique(diseased_duration_sec$primary_treatment))
dat.new$yhat = predict(lm.dd.s, type="response", newdata=dat.new)
preds = predict(lm.dd.s, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(lm.dd.s)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit-(2*se.fit)))


#boxplot of disease duration with model predictions
ggplot(diseased_duration_sec, aes(x=diseased_duration, y=log10.sec_dose, color=as.factor(log10.sec_dose)))+
  #geom_boxplot(width=0.05, outlier.shape = NA)+
  geom_point(data=dat.new, aes(x=yhat, y = log10.sec_dose), color="black")+
  geom_errorbar(data=dat.new, aes(xmin=Lower, xmax = Upper, x=yhat, y=log10.sec_dose), color="black", width=0)+
  geom_jitter(height=0.2, alpha=0.5)+
  labs(title = "Duration of Pathology: Secondary Infection", x="Duration of Pathology (Days)", y="log10(Secondary Treatment)", color="Secondary Treatment")+
  scale_color_manual(values=c(sec_colors))+
  facet_wrap(~primary_treatment)+
  theme_minimal()

#zoom in on high secondary
ggplot(diseased_duration_sec %>% filter(log10.sec_dose >2.5), aes(x=diseased_duration, y=primary_treatment, color=as.factor(log10.sec_dose)))+
  #geom_boxplot(width=0.05, outlier.shape = NA)+
  geom_point(data=dat.new %>% filter(log10.sec_dose >2.5), aes(x=yhat, y = primary_treatment), color="black")+
  geom_errorbar(data=dat.new %>% filter(log10.sec_dose >2.5), aes(xmin=Lower, xmax = Upper, x=yhat, y=primary_treatment), color="black", width=0)+
  geom_jitter(height=0.2, alpha=0.5)+
  labs(title = "Duration of Pathology: Secondary Infection High Dose", x="Duration of Pathology (Days)", y="Primary Treatment", color="Secondary Treatment")+
  scale_color_manual(values='#FA8072')+
  theme_minimal()

#all overlaid
ggplot(diseased_duration_sec, aes(x = diseased_duration, y = primary_treatment, color = as.factor(log10.sec_dose))) +
  geom_jitter(position = position_jitterdodge(dodge.width = -.75, jitter.width=2.5, jitter.height = 0), aes(group = primary_treatment), size = 2, alpha = 0.15) +
  geom_jitter(data = dat.new, position = position_dodge(width = -.75), aes(x = yhat, y = primary_treatment, color = as.factor(log10.sec_dose)), size = 2, alpha = 1, shape = 16) +
  geom_errorbar(data = dat.new,  position = position_dodge(width = -.75), aes(xmin = Lower, xmax = Upper, x = yhat, y = primary_treatment, color = as.factor(log10.sec_dose)), width = 0) +
  labs(title = "Duration of Pathology: Secondary Infection High Dose", x = "Duration of Pathology (Days)", y = "Primary Treatment", color = "Secondary Treatment") +
  scale_color_manual(values = c(sec_colors))+
  theme_minimal()

```


CV Secondary Inoculation
```{r Variation in Antibodies 2nd}
#Calculate CV, SD, and PV each day including secondary
m.ab$secondary_dose <- as.numeric(m.ab$secondary_dose)

#antibodies
s.pv <- m.ab %>% 
  group_by(dpi, primary_treatment, secondary_dose)%>%
  summarise(bird_cv = sd(elisa_od)/mean(elisa_od),
           bird_sd = sd(elisa_od),
          bird_pv = PV(elisa_od))

ggplot(s.pv%>%filter(dpi==56), aes(x=as.factor(secondary_dose), y=bird_pv, color=as.factor(secondary_dose)))+ 
  geom_point(size=3, aes(alpha="PV"))+
  geom_point(aes(x=as.factor(secondary_dose), y=bird_cv, color=as.factor(secondary_dose), alpha="CV"), size=3)+ 
  scale_color_manual(values=sec_colors)+
  #geom_path(aes(group=primary_treatment))+
  labs(x="Secondary Dose", y= "Variability", color= "Secondary Dose", alpha= "Variability Metric")+
  facet_wrap(~primary_treatment)
```

```{r Histograms Secondary}
#Add variable indicating the elisa_od mean for each secondary_dose
s.ab <- m.ab %>%
  filter(dpi > 41)%>%
  group_by(secondary_dose)%>%
  drop_na(elisa_od)%>%
  mutate(groupmean = mean(elisa_od))

#Add variable indicating the elisa_od mean for each secondary_dose:primary_dose
s.ab <- s.ab %>%
  group_by(secondary_dose, primary_dose)%>%
  mutate(groupmean.spi = mean(elisa_od))

#Add variable indicating the elisa_od mean for each secondary_dose:primary_dose:inf_sec
s.ab <- s.ab %>%
  group_by(secondary_dose, primary_dose, inf_sec)%>%
  mutate(groupmean.sp = mean(elisa_od))

#Histogram showing distribution of elisa_od by secondary_dose
ggplot(s.ab, aes(x=elisa_od, fill=as.factor(secondary_dose)))+
  #geom_density(color="black", alpha=0.5)+
  geom_histogram(binwidth = 0.005, position="identity", alpha=2, color="black", size=0.35)+
  geom_vline(xintercept=0.061, linetype="dashed", alpha=0.5)+
  xlim(c(0.04, 0.19))+
  geom_vline(aes(xintercept = groupmean.sp), linetype = "dotted", color = "red", alpha = 1) +
  labs(y= "Count", x= "Antibody Levels", fill="Secondary Dose", color= "Average OD")+
  scale_fill_manual(values=c(sec_colors))+
  scale_color_manual(values = c("red"), guide = guide_legend(title= "Group Mean"))+
  facet_grid(~primary_treatment~secondary_dose)+
  theme_minimal()

#Histogram showing mean of infected birds
ggplot(s.ab, aes(x=elisa_od, fill=as.factor(secondary_dose)))+
  #geom_density(color="black", alpha=0.5)+
  geom_histogram(binwidth = 0.005, position="identity", alpha=2, color="black", size=0.35)+
  geom_vline(xintercept=0.061, linetype="dashed", alpha=0.5)+
  xlim(c(0.04, 0.19))+
  geom_vline(aes(xintercept = groupmean.spi), linetype = "dotted", color = "red", alpha = 1) +
  labs(y= "Count", x= "Antibody Levels", fill="Secondary Dose", color= "Average OD")+
  scale_fill_manual(values=c(sec_colors))+
  scale_color_manual(values = c("red"), guide = guide_legend(title= "Group Mean"))+
  facet_grid(~secondary_dose~primary_treatment~inf_sec)+
  theme_minimal()


```


```{r Variation in Eyescore 2nd}
m.ab$tes.new <- m.ab$tes + 0.001
e.pv <- m.ab %>% 
  filter(dpi > 41)%>%
  group_by(dpi, primary_treatment, secondary_dose)%>%
  summarise(bird_cv = sd(tes.new)/mean(tes.new),
           bird_sd = sd(tes.new),
          bird_pv = PV(tes.new))

#eye score PV
ggplot(e.pv, aes(x=dpi, y=bird_pv, color=fct_rev(primary_treatment)))+ 
  geom_point(size=2)+
  #geom_point(s.pv, aes(x=primary_treatment, y=bird_pv))+
  scale_color_manual(values=pri_colors)+
  geom_path(aes(group=primary_treatment))+
  labs(x="Primary Treatment", y= "PV", color= "Primary Treatment", title = "Eye Score")+
  facet_wrap(~secondary_dose,nrow=1)

#remove uninfected birds
e.pv.i <- m.ab %>%
  filter(dpi > 41 & inf_sec == 1) %>%
  group_by(dpi, primary_treatment, secondary_dose) %>%
  summarise(
    bird_cv = sd(tes.new) / mean(tes.new),
    bird_sd = sd(tes.new),
    bird_pv = if(length(tes.new) >= 2) PV(tes.new) else 0
  ) %>%
  mutate(
    bird_cv = if_else(is.na(bird_cv), 0, bird_cv),
    bird_sd = if_else(is.na(bird_sd), 0, bird_sd)
  )%>%
  ungroup() 

#calculate average variability across secondary infection infected birds
e.pv.i.m <- e.pv.i%>%
  dplyr::select(primary_treatment, secondary_dose, bird_cv, bird_sd, bird_pv)%>%
  group_by(primary_treatment, secondary_dose)%>%
  summarise(
    avg_bird_cv = mean(bird_cv),
    avg_bird_sd = mean(bird_sd),
    avg_bird_pv = mean(bird_pv)
  )

#eye score PV infected birds
ggplot(e.pv.i%>% filter(dpi > 41), aes(x=dpi, y=bird_pv, color=fct_rev(primary_treatment)))+ 
  geom_point(size=2, aes(x=dpi, y=bird_pv), alpha=1)+
  geom_point(data=e.pv.i %>% filter(dpi > 41), aes(x=dpi, y=bird_cv), alpha=0.5)+
  scale_color_manual(values=pri_colors)+
  geom_path(aes(group=primary_treatment, x=dpi, y=bird_pv))+
  geom_path(aes(group=primary_treatment, x=dpi, y=bird_cv), linetype="dashed")+
  labs(x="Primary Treatment", y= "PV", color= "Primary Treatment", title = "Eye Score")+
  facet_wrap(~secondary_dose,nrow=1)

#mean PV infected birds
ggplot(e.pv.i.m, aes(x=as.factor(secondary_dose), y=avg_bird_pv, color=fct_rev(primary_treatment)))+ 
  geom_point(size=2)+
  #geom_point(s.pv, aes(x=primary_treatment, y=bird_pv))+
  scale_color_manual(values=pri_colors)+
  geom_path(aes(group=primary_treatment))+
  labs(x="Primary Treatment", y= "PV", color= "Primary Treatment", title = "Eye Score")
```


```{r Variation in Path Load 2nd}
g.pv <- m.ab %>% 
  filter(dpi > 41)%>%
  group_by(dpi, primary_treatment, secondary_dose)%>%
  summarise(bird_cv = sd(quantity1)/mean(quantity1),
           bird_sd = sd(quantity1),
          bird_pv = PV(quantity1))

#pathogen loads PV only above cutoff
m.ab$quantity1.inf <- ifelse(m.ab$quantity1 < m.ab$threshold_cutoff, 0.01, m.ab$quantity)
g.pv.inf <- m.ab %>% 
  filter(dpi > 41)%>%
  group_by(dpi, primary_treatment, secondary_dose)%>%
  summarise(bird_cv = sd(quantity1.inf)/mean(quantity1.inf),
           bird_sd = sd(quantity1.inf),
          bird_pv = PV(quantity1.inf))

#remove uninfected birds
p.pv.i <- m.ab %>%
  filter(dpi > 41 & inf_sec == 1) %>%
  group_by(dpi, primary_treatment, secondary_dose) %>%
  summarise(
    bird_cv = sd(quantity1) / mean(quantity1),
    bird_sd = sd(quantity1),
    bird_pv = if(length(quantity1) >= 2) PV(quantity1) else 0
  ) %>%
  mutate(
    bird_cv = if_else(is.na(bird_cv), 0, bird_cv),
    bird_sd = if_else(is.na(bird_sd), 0, bird_sd)
  )%>%
  ungroup() 

#path load PV
ggplot(g.pv, aes(x=dpi, y=bird_pv, color=fct_rev(primary_treatment)))+ 
  geom_point(size=2, aes(alpha="PV"), alpha = 1)+
  scale_color_manual(values=pri_colors)+
  geom_path(aes(group=primary_treatment))+
  labs(x="Day Post Infection", y= "PV", color= "Primary Treatment", title = "Pathogen Load")+
  facet_wrap(~secondary_dose,nrow=1)

#path load PV below cutoff removed
ggplot(p.pv.i, aes(x=dpi, y=bird_pv, color=fct_rev(primary_treatment)))+ 
  geom_point(aes(x=dpi, y=bird_pv), size=2, alpha = 1)+
  geom_point(aes(x=dpi, y=bird_cv), size=2, alpha=0.5)+
  scale_color_manual(values=pri_colors)+
  geom_path(aes(group=primary_treatment))+
  geom_path(aes(x=dpi, y=bird_cv, group=primary_treatment), linetype="dashed")+
  labs(x="Day Post Infection", y= "Variability", color= "Primary Treatment", title = "Pathogen Load")+
  facet_wrap(~secondary_dose,nrow=1)



```

```{r Path load and eye score raw data}
#install.packages("gtsummary")
library(gtsummary)
#overview table
m.ab %>%
  filter(dpi > 41)%>%
  dplyr::select(dpi, primary_treatment, secondary_dose, quantity1, tes, elisa_od)%>%
  gtsummary::tbl_summary(
    by=dpi,
    label=list(
      dpi ~ "Days Post Infection", primary_treatment ~ "Primary Treatment", secondary_dose ~ "Secondary Dose"
    ),
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c(
      "{mean}, {sd}"
    )
  ) %>%
  add_n() %>%
  bold_labels() %>%
  modify_header(label ~ "**Variable**")

m.ab %>%
#  filter(dpi == 14) %>%
  dplyr::select(dpi, primary_treatment, elisa_od, tes.new)%>%
  tbl_summary(
    by=dpi
  )

```

```{r Path load and eye score raw data}
#remove uninfected birds
p.i <- m.ab %>%
  filter(inf_sec == 1 & quantity1 > 1)

#path load quantity below cutoff removed by primary
ggplot(p.i %>% filter(dpi > 41), aes(x=dpi, y=log10(quantity1.inf), color=fct_rev(primary_treatment)))+ 
  geom_jitter(size=2, alpha = 0.25, height = 0, width=0.15)+
  scale_color_manual(values=pri_colors)+
  stat_summary(aes(group=primary_treatment), fun=mean, geom="line")+
    stat_summary(aes(group=primary_treatment), fun=mean, geom="point")+
      stat_summary(aes(group=primary_treatment), fun=mean, geom="point", color="black", shape=1)+
  labs(x="Day Post Infection", y= "Log10(Quantity+1)", color= "Primary Treatment", title = "Pathogen Load")+
  facet_wrap(~secondary_dose,nrow=1)+
  theme_minimal()

ggplot(g.pv, aes(x=dpi, y=bird_cv, color=fct_rev(primary_treatment)))+ 
  geom_point(alpha = 1, shape = 17)+
  geom_path(aes(group=primary_treatment, y=bird_cv), linetype="solid", alpha=1)+
  scale_color_manual(values=pri_colors)+
  labs(x="Primary Treatment", y= "CV", color= "Primary Treatment", title = "Pathogen Load")+
  facet_wrap(~secondary_dose,nrow=1)

   
m.ab$dpsi <- as.numeric(m.ab$dpsi)
#log10(quant1)
quant.raw <- ggplot(m.ab %>% filter(dpsi %in% c(4, 7, 14, 21)), aes(x=dpsi, y=log10(quantity1), color=fct_rev(primary_treatment)))+
  geom_hline(yintercept = log10(50))+
  geom_jitter(alpha=0.5, width=0.1)+
  stat_summary(aes(x=dpsi, y=log10(quantity1), groups=primary_treatment), fun=mean, geom="point")+
  stat_summary(aes(x=dpsi, y=log10(quantity1), groups=primary_treatment), fun=mean, geom="line")+
    labs(x="Day Post Secondary Inoculation", y= "log10(quntity1)", color= "Primary Treatment", title = "Pathogen Load")+
    scale_color_manual(values=pri_colors)+
  facet_wrap(~secondary_dose, nrow=1)

#quant1
quant1.raw <- ggplot(m.ab %>% filter(dpsi %in% c(4, 7, 14, 21)), aes(x=dpsi, y=quantity1, color=fct_rev(primary_treatment)))+
  geom_hline(yintercept = 50)+
  geom_point(alpha=0.5)+
  stat_summary(aes(x=dpsi, y=quantity1, groups=primary_treatment), fun=mean, geom="point")+
  stat_summary(aes(x=dpsi, y=quantity1, groups=primary_treatment), fun=mean, geom="line")+
    scale_color_manual(values=pri_colors)+
  facet_wrap(~secondary_dose, nrow=1)


tes.raw <- ggplot(m.ab %>% filter(dpsi %in% c(4, 7, 14, 21)), aes(x=dpsi, y=tes, color=fct_rev(primary_treatment)))+
  geom_point( alpha=0.5)+
  stat_summary(aes(x=dpsi, y=tes, groups=primary_treatment), fun=mean, geom="point")+
    stat_summary(aes(x=dpsi, y=tes, groups=primary_treatment), fun=mean, geom="line")+
    scale_color_manual(values=pri_colors)+
      labs(x="Day Post Secondary Inoculation", y= "Total Eye Score", color= "Primary Treatment", title = "Eye Score")+
  facet_wrap(~secondary_dose, nrow=1)

quant.raw
quant1.raw
tes.raw

```

```{r Mean Path load / Model Preds}
p.i <- m.ab %>%
  filter(inf_sec == 1 & quantity1 > 1 & dpi > 41)
p.i$log10.sec_dose <- log10(p.i$secondary_dose)
p.i$dpi.f <- as.factor(p.i$dpi)
hist(p.i$log10_quantity1)
p.i$band_number <- as.numeric(p.i$band_number)
#model
glm.path <- glm(log10_quantity1 ~ primary_treatment * log10.sec_dose + dpi.f + (1|band_number), data=p.i)
summary(glm.path)
simulateResiduals(glm.path, plot=T)
hist(resid(glm.path))
mod.pred <- glm.path
dat.new=expand.grid(primary_treatment=unique(p.i$primary_treatment),
                    log10.sec_dose = unique(p.i$log10.sec_dose),
                    dpi.f = unique(p.i$dpi.f),
                    band_number = unique(p.i$band_number))

dat.new$yhat = predict(mod.pred, type="response", newdata=dat.new, re.form=NA) #predicted values based off lm2 model
preds = predict(mod.pred, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(mod.pred)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))
head(dat.new)

#path load quantity below cutoff removed by primary means
ggplot(p.i %>% filter(dpi > 41 & inf_sec == 1), aes(x=dpi.f, y=log10_quantity1, color=fct_rev(primary_treatment)))+ 
  geom_jitter(size=2, alpha = 0.25, height = 0, width=0.15)+
  scale_color_manual(values=pri_colors)+
  stat_summary(aes(group=primary_treatment), fun=mean, geom="line")+
  stat_summary(aes(group=primary_treatment), fun=mean, geom="point")+
  stat_summary(aes(group=primary_treatment), fun=mean, geom="point", color="black", shape=1)+
  labs(x="Day Post Infection", y= "Log10(Quantity+1)", color= "Primary Treatment", title = "Pathogen Load")+
  facet_wrap(~log10.sec_dose,nrow=1)+
  theme_minimal()

#path load quantity below cutoff removed by primary with model predictions
ggplot(p.i %>% filter(dpi > 41 & inf_sec == 1), aes(x=dpi.f, y=log10_quantity1, color=fct_rev(primary_treatment)))+ 
  geom_jitter(size=2, alpha = 0.25, height = 0, width=0.15)+
  scale_color_manual(values=pri_colors)+
  # stat_summary(aes(group=primary_treatment, shape = as.factor(log10.sec_dose)), fun=mean, geom="line")+
  # stat_summary(aes(group=primary_treatment, shape = as.factor(log10.sec_dose)), fun=mean, geom="point")+
  # stat_summary(aes(group=primary_treatment), fun=mean, geom="point", color="black", shape=1)+
  geom_point(data=dat.new, aes(x=dpi.f, y=yhat))+
  geom_line(data=dat.new, aes(x=dpi.f, y=yhat, group=primary_treatment))+
  geom_errorbar(data=dat.new, aes(ymin=Lower, ymax=Upper, x=dpi.f, y=yhat), width=0.1, alpha=0.1)+
  labs(x="Day Post Infection", y= "Log10(Quantity+1)", color= "Primary Treatment", title = "Pathogen Load")+
  facet_wrap(~log10.sec_dose,nrow=1)+
  theme_minimal()

```
```{r Mean eye score / model preds}
p.i$band_number <- as.numeric(p.i$band_number)
glm.eye <- glm(tes.new ~ primary_treatment * log10.sec_dose + dpi.f + (1|band_number), data=p.i)
simulateResiduals(glm.eye, plot=T)

mod.pred <- glm.eye
dat.new=expand.grid(primary_treatment=unique(p.i$primary_treatment),
                    log10.sec_dose = unique(p.i$log10.sec_dose),
                    dpi.f = unique(p.i$dpi.f),
                    band_number = unique(p.i$band_number))

dat.new$yhat = predict(mod.pred, type="response", newdata=dat.new, re.form=NA) #predicted values based off lm2 model
preds = predict(mod.pred, type="link", newdata=dat.new, se.fit=T)
dat.new = cbind(dat.new, preds)

ilink <- family(mod.pred)$linkinv
dat.new <- transform(dat.new,
                     Fitted = ilink(fit),
                     Upper = ilink(fit + (2*se.fit)),
                     Lower = ilink(fit - (2*se.fit)))
head(dat.new)

#
ggplot(p.i, aes(x=dpi.f, y=tes, color=fct_rev(primary_treatment)))+
  geom_jitter(alpha=0.25, height=0, width=0.15)+
  geom_point(data=dat.new, aes(x=dpi.f, y=yhat), color='black')+
  geom_line(data=dat.new, aes(x=dpi.f, y=yhat, group=primary_treatment), alpha=0.5)+
  geom_errorbar(data=dat.new, aes(x=dpi.f, y=yhat, ymin=Lower, ymax=Upper), width=0.1)+
    scale_color_manual(values=pri_colors)+
      labs(x="Day Post Secondary Inoculation", y= "Total Eye Score", color= "Primary Treatment", title = "Eye Score")+
  facet_wrap(~log10.sec_dose, nrow=1)+
  ylim(ymin=-1, ymax=5)+
  theme_minimal()

ggplot(p.i, aes(x=dpi, y=tes, color=fct_rev(primary_treatment)))+
  geom_jitter(alpha=0.25, height=0, width=0.15)+
  stat_summary(aes(x=dpi, y=tes, groups=primary_treatment), fun=mean, geom="point")+
    stat_summary(aes(x=dpi, y=tes, groups=primary_treatment), fun=mean, geom="point", color="black", shape=1)+
    stat_summary(aes(x=dpi, y=tes, groups=primary_treatment), fun=mean, geom="line")+
    scale_color_manual(values=pri_colors)+
      labs(x="Day Post Secondary Inoculation", y= "Total Eye Score", color= "Primary Treatment", title = "Eye Score")+
  facet_wrap(~secondary_dose, nrow=1)+
  theme_minimal()


```


Bin Secondary Sham, Low, Medium, High
```{r}

```

