---
title: "EEID 1A Antibody Analysis"
author: "Jesse Garrett-Larsen"
date: "2024-01-26"
output: 
  html_document: 
    keep_md: yes
---

Load packages
```{r Load Packages}
rm(list=ls())
library(tidyverse)
library(dplyr)
#install.packages("glmmTMB")
library(glmmTMB)
library(effects)
library(AICcmodavg)
#install.packages("emmeans")
library(emmeans)
library(DHARMa)
```

```{r Read In Data + Merge}
master <- read.csv("EEID2021_master_data_20220503.csv")
ab <- read.csv("EEID_1a_ELISA.csv")
m.ab <- left_join(master, ab, by = "bird_ID", keep=TRUE)
```
Format Data
```{r Format}
m.ab[m.ab == "f "] <- "f"

m.ab <- m.ab %>%
  dplyr::select(- date.y, -bird_ID.y, -band_number.y, -dpi, -(X:X.13)) #remove extra columns

#rename columns
names(m.ab)[names(m.ab) == "date.x"] <- "date"
names(m.ab)[names(m.ab) == "band_number.x"] <- "band_number"
names(m.ab)[names(m.ab) == "bird_ID.x"] <- "bird_ID"
names(m.ab)[names(m.ab) == "Avg.OD"] <- "elisa_od"
names(m.ab)[names(m.ab) == "CV"] <- "elisa_cv"
names(m.ab)[names(m.ab) == "dppi"] <- "dpi"


m.ab$sex <- as.factor(m.ab$sex)
m.ab$sex <- factor(m.ab$sex, levels = c("f", "m"), labels = c("Female", "Male"))
m.ab$primary_treatment <- as.factor(m.ab$primary_treatment)
levels(m.ab$primary_treatment) <- c("High", "Low", "Sham")
m.ab$primary_treatment <- factor(m.ab$primary_treatment, levels = c("Sham", "Low", "High"))
m.ab$l_eye_score <- as.numeric(m.ab$l_eye_score)
m.ab$r_eye_score <- as.numeric(m.ab$r_eye_score)
#total eye score = sum of l and r eye score
m.ab$tes <- m.ab$l_eye_score + m.ab$r_eye_score

```
Generate Threshold Cutoffs for Pathogen Load and Antibody Levels
```{r Thresholds}
m.ab$threshold_cutoff = 15
m.ab$seropos_cutoff = 0.061
m.ab$pathology_cutoff = 0
```
Generate new infected and seroconversion columns based off of cutoffs
```{r Infection + Seroconversion + Eye Score}
#generate infected column - if copy number > 50, infected.
#for each timepoint only - can become infected or uninfected at next timepoint
m.ab <- m.ab %>%
  mutate(infected = ifelse(quantity>threshold_cutoff, 1, 0))

#generate infection data; if path load > 50 copies = infected
#1 = bird was successfully infected at any point during the priming phase of the experiment
#coalesce function replaces any NA with 0 here. 
#To be conservative, I am always assuming there is no path load unless it's measured with qPCR
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(infected_prim = ifelse(any(coalesce(dpi, 0) < 42 & coalesce(infected, 0) == 1), 1, 0)) %>%
  ungroup()

#generate infection data; if path load > 50 copies any time after secondary infection -> 1
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate (infected_sec = ifelse(any(coalesce(dpi, 0) > 42 & coalesce(infected, 0) == 1), 1, 0)) %>%
  ungroup()

#generate seropositivity data; if elisa OD > 0.061 = seropositive
#1 = bird seroconverted at any point during the priming phase of the experiment
m.ab <- m.ab %>%
  mutate(seropos = ifelse(elisa_od>seropos_cutoff, 1, 0))

m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(ever_seropos = ifelse(any(coalesce(dpi, 0) < 42 & coalesce(seropos, 0) == 1), 1, 0)) %>%
  ungroup()

#generate eye score data; if eye score > 0 = diseased
#1 = bird had an eye score at that time point
m.ab <- m.ab %>%
  mutate(diseased = ifelse(tes>pathology_cutoff, 1, 0))

#ever diseased during primary infection
m.ab <- m.ab %>%
  group_by(band_number) %>%
  mutate(ever_diseased = ifelse(any(coalesce(dpi, 0) < 42 & coalesce(diseased, 0) == 1), 1, 0)) %>%
  ungroup()

```

```{r Eye Score Formatting}
ggplot(m.ab %>% filter(dpi < 42), aes(x=tes, y=tes, color=band_number))+
  geom_jitter(height=0.1)+
  facet_wrap(~infected_prim)
#2415 has eye score but no path load - super resistant?
```
```{r Omit 2505}
#check for seropositive birds from quarantine from dataset
m.ab %>%
  filter(dpi == -8) %>%
  filter(elisa_od >= 0.061)%>%
  dplyr::select(band_number, elisa_od, primary_treatment, secondary_treatment, infected, seropos, dpi, ELISA.Run.Date)

#omit 2505 from data set for analysis as it was positive at quarantine
m.ab <- m.ab %>%
  filter(band_number != 2505)

#which birds are seropositive but qPCR negative?
m.ab%>%
  filter(infected_prim == 0 & elisa_od > 0.061 & dpi < 42)%>%
  dplyr::select(band_number, dpi, tes, elisa_od, quantity, primary_treatment)
```

```{r Format DPI}
#some sample days were split between two days. 
#One day experimental birds were measured (dpi -8 and dpi 14), the next day infected birds were measured (dpi -7, dpi15)
#this code makes a new column dpi.new that combines dpi 14 and 15
m.ab$dpi.new <- ifelse(m.ab$dpi %in% c(14, 15), "14", as.integer(m.ab$dpi))

#i then use dpi.new to replace the dpi column to combine dpi -7 and -8
m.ab$dpi <- ifelse(m.ab$dpi %in% c(-7, -8), "-8", as.integer(m.ab$dpi.new))

m.ab$dpi.new <- NULL #delete dpi.new column

m.ab$dpi <- as.numeric(m.ab$dpi)

m.ab <- m.ab %>%
  filter(experiment_location == "vt") #include only birds at VT
```
General overview of antibody responses
```{r, warning=FALSE}
ggplot(m.ab %>% filter(dpi <= 41), aes(x=dpi, y=elisa_od, color=fct_rev(primary_treatment)))+
  geom_point()+
  geom_hline(yintercept = 0.061)+
  stat_smooth(aes(x=dpi, y=elisa_od, group=band_number), alpha=0.5, size=0.5, span=1)+
  #scale_color_manual(values = c("red", "green4","blue"))+
  labs(x="Days Post Infection", y="ELISA OD", color="Primary Treatment")+
  facet_wrap(~primary_treatment)
```


Duration of disease * this is wrong *
```{r}
m.ab$dpi <- as.numeric(m.ab$dpi)
diseased_duration <- m.ab %>%
  filter(diseased == 1) %>%
  group_by(band_number, primary_treatment, sex) %>%
  summarize(diseased_duration = max(dpi) - min(dpi))
diseased_duration
diseased_duration$diseased_duration <- as.numeric(diseased_duration$diseased_duration)


hist(diseased_duration$diseased_duration, breaks = 25)
ggplot(diseased_duration, aes(x=diseased_duration))+
  geom_histogram(aes(fill=fct_rev(primary_treatment)), position="dodge", bins = 15)+
  labs(x="Duration of Pathology", y="Count", fill="Primary Treatment")
#there are sham birds on this graph with 20 days of pathology :()
```

####Does Inoculation Dose Predict Antibody Levels?####
```{r New df p.ab for primary }
#data frame with only primary infection (no PID 56)
p.ab <- m.ab %>%
  filter(dpi <=41)
```

I use a gamma distribution for the antibody data
With models spanning multiple days, band_number is included as a random effect

Do I use a log link function or inverse link function? Compare AIC and logLik
Skipping ahead here with models, but showing that *inverse link works better*
```{r Inverse vs Log Link}
#pre-infection
lm0a <- glm(elisa_od~primary_treatment, data=p.ab %>% filter(dpi <0), family=Gamma())
lm0b <- glm(elisa_od~primary_treatment, data=p.ab %>% filter(dpi <0), family=Gamma(log))

aictab(cand.set=list(lm0a, lm0b), modnames=c("inv","log"))
#no difference between the two

#Across all infection
ps1 <- glmmTMB(elisa_od~primary_treatment + (1|band_number), data=p.ab, family=Gamma())
ps2 <- glmmTMB(elisa_od~primary_treatment + (1|band_number), data=p.ab, family=Gamma(log))

aictab(cand.set=list(ps1, ps2), modnames=c("inv","log"))
#inverse link function is slightly better

#DPI 14
p1a <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi ==14), family=Gamma())
p2a <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi ==14), family=Gamma(log))

aictab(cand.set=list(p1a, p2a), modnames=c("inv","log"))
#no difference 

#DPI 41
p1b <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi ==41), family=Gamma())
p2b <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi ==41), family=Gamma(log))

aictab(cand.set=list(p1b, p2b), modnames=c("inv","log"))
#no difference
```

Baseline antibody levels were not significantly different from each other before inoculation.

emmeans shows estimated marginal means for variables and allows for post-hoc pairwise comparisons using the Tukey-Kramer method to minimize type 1 error.
```{r Baseline antibody levels were not significantly different}
lm0 <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi <0), family=Gamma())
summary(lm0)
plot(allEffects(lm0))

emm_r <- emmeans(lm0, ~primary_treatment)
pairs(emm_r)

```

Using primary_treatment (categorical), I show that birds inoculated with MG produce antibodies in a dose-dependent manner.

Across all days primary infection, inoculation dose 
```{r}
lm1 <- glmmTMB(elisa_od~primary_treatment + (1|band_number), data=p.ab, family=Gamma())
summary(lm1)

l1r <- simulateResiduals(lm1)
plot(l1r)

#model comparison 
p1 <- glmmTMB(elisa_od~primary_treatment + (1|band_number), data=p.ab, family=Gamma())
p2<- glmmTMB(elisa_od~primary_treatment + sex + (1|band_number), data=p.ab, family=Gamma())
p3<- glmmTMB(elisa_od~primary_treatment * sex + (1|band_number), data=p.ab, family=Gamma())
p4 <- glmmTMB(elisa_od~1 + (1|band_number), data=p.ab, family=Gamma())
p5 <- glmmTMB(elisa_od~primary_treatment + mass + (1|band_number), data=p.ab, family=Gamma())

aictab(cand.set=list(p1, p2, p3, p4, p5), modnames=c("p1","p2", "p3", "p4", "p5"))

emm_results <- emmeans(lm1, ~ primary_treatment, scale="response")
pairs(emm_results)

#antibodies across all days primary infection
ggplot(data=p.ab, aes(x=dpi, y= elisa_od, shape=primary_treatment,
                      color=fct_rev(primary_treatment)))+
  geom_jitter(width=5, size=1.5)+
  geom_line(aes(x=dpi, y=elisa_od, group = as.factor(band_number)))+
  geom_hline(yintercept = 0.061, linetype="dashed")+
  stat_summary(aes(group=primary_treatment), fun=mean, geom="line")+
  stat_summary(aes(group=primary_treatment, shape = primary_treatment), fun.y=mean,
               fun.min = function(x) mean(x)-sd(x),
               fun.max = function(x) mean(x)+sd(x),
               geom= "errorbar", size=.75, width=2)+
  labs(title = "Antibody Levels Primary Infection", y="Antibody Levels", 
       x= "Primary Treatment", shape="Primary Treatment", color="Primary Treatment")
```

```{r Antibody levels on day 14 post infection were sig different between groups}
#Final Model
lm2 <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi == 14), family=Gamma())
summary(lm2)

emm_results <- emmeans(lm2, ~ primary_treatment, scale="response")
emm_results
pairs(emm_results)

plot(allEffects(lm2))

#model comparison
pr1 <- glmmTMB(elisa_od~primary_treatment, data=p.ab %>% filter(dpi == 14), family=Gamma())
pr2<- glmmTMB(elisa_od~primary_treatment + sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
pr3<- glmmTMB(elisa_od~primary_treatment * sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
pr4 <- glmmTMB(elisa_od~primary_treatment * room , data=p.ab %>% filter(dpi == 14), family=Gamma())
pr5 <- glmmTMB(elisa_od~1, data=p.ab %>% filter(dpi == 14), family=Gamma())
pr6 <- glmmTMB(elisa_od~primary_treatment + mass, data=p.ab %>% filter(dpi == 14), family=Gamma())
pr7 <- glmmTMB(elisa_od~primary_treatment + room , data=p.ab %>% filter(dpi == 14), family=Gamma())

#AICc
aictab(cand.set=list(pr1, pr2, pr3, pr4, pr5, pr6, pr7), modnames=c("pr1","pr2", "pr3", "pr4", "pr5", "pr6", "pr7"))


#There were 15 blood samples that were lost before they were run and are not included in this graph
missing_samples <- p.ab %>%
  filter(dpi %in% c(-8, 14, 41) & is.na(elisa_od)) %>%
  dplyr::select(band_number, bird_ID, dpi, elisa_od)
print(missing_samples)

#Model predictions
dat.new=expand.grid(primary_treatment=unique(p.ab$primary_treatment))#new grid to put predictions into
dat.new$yhat = predict(lm2, type="response", newdata=dat.new, re.form=NA) #predicted values based off lm2 model
head(dat.new)

#graph showing antibody levels on day 14 post-infection with model predictions
pid14.pred <- ggplot(data=p.ab %>% filter(dpi == 14), aes(x=primary_treatment, y=elisa_od, shape=primary_treatment))+
  geom_jitter(size=2, width=0.25)+
  geom_point(data=dat.new, aes(x=primary_treatment, y=yhat, shape=primary_treatment), size=10, shape="-", color="brown")+#model predictions
  scale_shape_manual(values = c(16, 17, 15))+
  geom_hline(yintercept=0.061, linetype="dashed", alpha=0.5)+
  labs(title="MG Antibodies Day 14", x="Primary Treatment", y="Antibody Levels", shape="Primary Treatment")

pid14.pred

```
I also looked at primary_dose, a continuous variable to test whether inoculation dose affects antibody response.

```{r Primary Dose Continuous Day 14}
#model comparison
prd1 <- glm(elisa_od~primary_dose, data=p.ab %>% filter(dpi == 14), family=Gamma())
prd2<- glm(elisa_od~primary_dose + sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd2.5<- glm(elisa_od~primary_dose * sex , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd3 <- glm(elisa_od~primary_dose + room , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd4 <- glm(elisa_od~primary_dose * room , data=p.ab %>% filter(dpi == 14), family=Gamma())
prd5 <- glm(elisa_od~1, data=p.ab %>% filter(dpi == 14), family=Gamma())
prd6 <- glm(elisa_od~primary_dose + mass, data=p.ab %>% filter(dpi == 14), family=Gamma())

#AICc
aictab(cand.set=list(prd1, prd2, prd2.5, prd3, prd4, prd5, prd6), modnames=c("prd1", "prd2", "prd2.5", "prd3", "prd4", "prd5", "prd6"))

summary(prd1)

#continuous model predictions
dat.new2 <- data.frame(primary_dose = seq(min(p.ab$primary_dose), max(p.ab$primary_dose), length.out = 10))
dat.new2$yhat <- predict(prd1, type = "response", interval = "confidence", level = 0.95, newdata = dat.new2)

#plot continuous predicted values over raw data
pid14.dose.pred.c <- ggplot(data=p.ab %>% filter(dpi == 14), aes(x=primary_dose, y=elisa_od))+
  geom_jitter(size=2, width=0.5, shape = 1)+
  geom_line(data=dat.new2, aes(x=primary_dose, y=yhat), color="brown")+#model predictions
  labs(x="Primary Dose", y="Antibody Levels", shape="Primary Dose")

pid14.dose.pred.c
```
Alternatively, I can subset the primary_dose into facors based on primary_dose. This maintains the continuous nature of the data, but allows for pairwise comparisons using emmeans.
```{r Primary Dose continuous pairwise comparisons day 14}
# Create a new factor variable based on primary_dose
p.ab <- p.ab %>% mutate(primary_dose_group = cut(primary_dose, breaks = c(-Inf, 100, 2000, Inf), labels = c("Sham", "Low", "High")))

# Fit glm with  new factor variable
prdc1 <- glm(elisa_od ~ primary_dose_group, data = p.ab %>% filter(dpi == 14), family = Gamma())

# Calculate estimated marginal means (EMMs)
emm_results <- emmeans(prdc1, specs = "primary_dose_group")

# Conduct pairwise comparisons between the groups
pairs(emm_results)

```
Antibody levels return to baseline in the low (p = 0.149), but not high dose (p < 0.001) groups by day 41.
```{r Antibody levels on day 41 post infection were sig different between groups}
lm3 <- glm(elisa_od~primary_treatment, data=p.ab %>% filter(dpi==41), family=Gamma())
summary(lm3)

emm_results<- emmeans(lm3, ~ primary_treatment)
pairs(emm_results)

#model comparison
p1 <- glm(elisa_od~primary_treatment, data=p.ab %>% filter(dpi==41), family=Gamma())
p2<- glm(elisa_od~primary_treatment + sex , data=p.ab %>% filter(dpi==41), family=Gamma())
p3<- glm(elisa_od~primary_treatment * sex , data=p.ab %>% filter(dpi==41), family=Gamma())
p4 <- glm(elisa_od~primary_treatment + quantity , data=p.ab %>% filter(dpi==41), family=Gamma())
p5 <- glm(elisa_od~1, data=p.ab %>% filter(dpi==41), family=Gamma())
p6 <- glm(elisa_od~primary_treatment + mass, data= p.ab %>% filter(dpi==41), family=Gamma())

#AICc
aictab(cand.set=list(p1, p2, p3, p4, p5, p6), modnames=c("p1", "p2", "p3", "p4", "p5", "p6"))

summary(p2)
#p2 is the best model
#but sex adds complexity and is not significant (0.1445) so remove

#p1 is second best - use
summary(p1)

#model predictions
dat.newer=expand.grid(primary_treatment=unique(p.ab$primary_treatment))#new grid to put predictions into
dat.newer$yhat = predict(lm3, type="response", newdata=dat.newer, re.form=NA) #predicted values based off lm3  model
head(dat.newer)

#plot predicted values over raw data
pid41.pred <- ggplot(data = m.ab %>% filter(dpi == 41), aes(x = primary_treatment, y = elisa_od, shape = primary_treatment)) +
  geom_jitter(size=1.5, width = 0.25) +
  geom_hline(yintercept = 0.061, color = "black", alpha = 0.75, linetype='dashed') +
  labs(x="Inoculation Dose", y= "MG Antibodies OD", shape = "Primary Treatment")+
  geom_point(data=dat.newer, aes(x=primary_treatment, y=yhat, shape=primary_treatment), size=10, shape="-", color="brown4")#model predictions

pid41.pred
```

Antibody levels return to baseline in the low (p = 0.149), but not high dose (p < 0.001) groups by day 41.
```{r Primary Dose Continuous Day 41}
#model comparison
pr1 <- glm(elisa_od~primary_dose, data=p.ab %>% filter(dpi==41), family=Gamma())
pr2<- glm(elisa_od~primary_dose + sex , data=p.ab %>% filter(dpi==41), family=Gamma())
pr3<- glm(elisa_od~primary_dose * sex , data=p.ab %>% filter(dpi==41), family=Gamma())
pr4 <- glm(elisa_od~primary_dose + quantity , data=p.ab %>% filter(dpi==41), family=Gamma())
pr5 <- glm(elisa_od~1, data=p.ab %>% filter(dpi==41), family=Gamma())
pr6 <- glm(elisa_od~primary_dose + mass, data= p.ab %>% filter(dpi==41), family=Gamma())


#AICc
aictab(cand.set=list(pr1, pr2, pr3, pr4, pr5, pr6), modnames=c("pr1", "pr2", "pr3", "pr4", "pr5", "pr6"))

#pr2 best model
#but sex adds complexity and is not significant (0.146) so remove

summary(pr1)

#continuous model predictions
dat.newer2 <- data.frame(primary_dose = seq(min(p.ab$primary_dose), max(p.ab$primary_dose), length.out = 100))
dat.newer2$yhat <- predict(pr1, type = "response", interval = "confidence", level = 0.95, newdata = dat.newer2)
head(dat.newer2)

pid41.dose.pred.c <- ggplot(data=p.ab %>% filter(dpi == 41), aes(x=primary_dose, y=elisa_od))+
  geom_jitter(size=2, width=0.1)+
  geom_line(data=dat.newer2, aes(x=primary_dose, y=yhat), color="brown")+#model predictions
  labs(title = "ELISA OD PID 41", x="Primary Dose", y="ELISA OD", shape="Primary Dose")+
  geom_hline(yintercept = 0.061, color = "black", alpha = 0.75, linetype='dashed')

pid41.dose.pred.c

#pairwise comparisons
p.ab <- p.ab %>% mutate(primary_dose_group = cut(primary_dose, breaks = c(-Inf, 100, 2000, Inf), labels = c("Sham", "Low", "High")))

# Fit glm with  new factor variable
pr1 <- glm(elisa_od~primary_dose_group, data=p.ab %>% filter(dpi==41), family=Gamma())

# Calculate estimated marginal means (EMMs)
emm_results <- emmeans(pr1, specs = "primary_dose_group")

# Conduct pairwise comparisons between the groups
pairs(emm_results)

```



*Summary: *
